/*
 * detector.c
 *
 *  Created on: Dec 22, 2014
 *      Author: hutch
 */

#include "supportFiles/interrupts.h"
#include <stdint.h>
#include "isr.h"
#include "stdio.h"
#include "detector.h"
#include "filter.h"
#include "lockoutTimer.h"
#include "hitLedTimer.h"
#include "supportFiles/switches.h"

#define TRANSMITTER_TICK_MULTIPLIER 3	// Call the tick function this many times for each ADC interrupt.
#define FILTER_QUANTITY 10
#define FUDGE_FACTOR 20
#define ACCESS_POWERVAL
#define ACCESS_PLAYERNUM
#define DETECTOR_TEST_MODE false
#define DETECTOR_SCALEADC 2048
#define DETECTOR_SHIFTADC 1
#define TEST_DATA_COUNT 5000
#define TEST_ITERATIONS 2000
double testDataA[FILTER_QUANTITY] = {150,20,40,10,15,30,35,15,25,80};
double testDataB[FILTER_QUANTITY] = {50,55,65,70,150,10,25,30,30,45};
double inputTest[FILTER_QUANTITY][2];
double expectedDataA[FILTER_QUANTITY] = {10,15,15,20,25,30,35,40,80,150};
double expectedDataB[FILTER_QUANTITY] = {10,25,30,30,45,50,55,65,70,150};


static double InputTestData[TEST_DATA_COUNT] = {1181,1421,1518,1394,1223,1305,1300,1100,1157,1054,1436,1137,1134,1305,1066,1059,1219,1372,1037,1266,1102,1127,977,1387,1496,1029,1261,1337,1326,1346,1314,1170,1224,1099,1544,1144,1071,1276,1402,1204,1270,1238,1066,1325,1076,1136,1262,1215,1275,1287,1088,1006,1422,1308,1201,1443,966,1254,1244,1507,1283,1364,1494,1069,945,1236,1183,1223,1177,986,1258,1176,1337,1376,1308,1045,1098,1350,1017,1176,1120,1123,1116,1161,1313,1138,897,989,1422,1332,1199,1305,1356,1202,1309,1268,1261,1274,1051,1310,1023,1109,1164,1281,1356,1231,1073,1207,1373,1156,1243,1453,1208,1451,1313,1249,1183,1397,1269,1043,1232,1230,1252,1386,1480,1303,1419,1084,1343,1318,1361,1358,1025,1277,1350,1049,1195,1133,1106,1371,953,1129,1300,1395,1520,1220,1335,1301,1113,1400,1242,1395,1111,1287,1240,1528,1422,1208,1009,1315,1261,1456,941,1327,1149,1345,1064,1129,1173,1259,1535,1285,1313,1357,1074,1200,1181,1104,1409,1295,1450,1388,1235,1397,1305,1724,1310,1307,1153,1111,1378,1124,1205,999,970,1349,1307,1147,1381,1180,1274,1218,1401,1320,1148,1249,1411,1210,1216,1090,1400,1210,1243,1113,1291,1182,1275,1208,1354,1197,1280,989,1248,1500,1147,1312,1301,1095,1202,1117,1105,1171,1448,1582,1165,1331,1436,1221,1473,1297,1380,1214,1170,1401,1281,1409,1296,1150,1182,1330,1181,1074,981,973,1159,1233,1201,1072,1202,1321,1145,1104,1312,1101,1321,1177,985,1329,1426,1124,1283,1268,1267,1430,1348,1260,1196,1202,1195,1187,1212,874,1185,1345,1018,1481,1248,1213,1093,1157,1114,1046,1160,1341,1299,1043,1239,1545,1250,1135,1193,890,1208,1127,1049,1249,1333,1253,1222,1039,1072,1255,1225,1175,1124,1277,1368,1092,1532,1147,1163,1199,1448,1168,1351,1179,1294,1392,1314,1129,1264,1318,1528,1288,1344,1175,1226,1045,1229,1073,1226,1229,1258,1555,1155,1230,1255,1160,1388,1203,1301,1073,1192,1096,1287,1438,1205,1213,1514,1360,1440,1366,1635,1346,1283,1302,1127,1298,1225,1320,1007,1193,1462,981,1140,1351,1223,1186,1141,1217,1486,1347,1153,1191,1359,1003,1115,1078,1061,1209,1322,1250,1266,1125,1160,1253,1495,1235,1268,1098,1332,1149,1012,1407,1365,1305,1045,1076,1351,1107,1086,1292,1003,1366,1319,1391,1200,1270,1335,1275,1250,1394,1190,1197,1206,1265,1472,1485,1332,1230,1335,1066,1251,1281,976,1312,1037,1331,1135,1210,1076,1093,1078,1151,1279,1045,1278,1138,1415,1313,1349,1207,1023,1179,1170,1351,1277,1361,957,1503,1253,1389,1049,1216,925,1183,1272,1292,1212,1216,1088,1307,1351,1415,1413,1405,1101,1063,1306,1321,1016,1034,1393,1338,1180,1355,1213,1320,1350,1201,1159,1079,990,1198,1073,1098,1117,1220,1030,1236,1362,937,1068,1087,1487,1439,1498,1224,1163,1207,1415,1073,1348,1282,1332,1309,1027,1207,1245,1317,1299,1421,1193,990,1005,1211,1103,1218,1189,1186,1321,1239,1167,1645,1368,1288,1086,1317,1433,1609,1414,1219,1476,1452,1050,1261,1378,1163,1101,1217,1223,1248,1243,1430,886,1279,1209,1041,1259,1293,1422,1088,1060,1575,1294,1092,1144,1385,1207,1300,1158,1323,1016,1197,1284,1370,1211,1152,1104,1114,1054,1321,1048,1184,1194,1250,1391,1265,1111,1115,1043,1018,1129,1236,1358,1302,1375,1486,1309,1173,1006,1336,1426,1314,1342,1339,1394,1318,1120,1302,1296,1203,1036,1181,1048,1190,1302,1230,1155,1198,1205,1296,1371,1171,1213,1254,1295,1456,1121,1503,1320,1134,1271,1302,1279,1234,1411,1495,1312,1239,1264,1131,1329,1053,967,952,1311,1161,1073,1036,1151,1166,1074,1285,1522,1289,1138,1327,1383,1383,1380,1450,1536,1255,1227,1093,1242,1460,1430,1236,1028,1285,1086,1072,1397,1121,1141,1132,1272,1230,1243,1175,991,1126,1334,1609,1219,1369,1286,897,1099,1115,1538,1201,1294,1415,1233,1029,1229,1356,1054,1304,1369,1243,1126,1226,1233,1081,1209,1282,1078,1295,1289,1102,1314,1030,1470,1129,1274,1406,1033,1419,1291,1083,1107,1251,1149,1144,1185,1017,1082,1265,1048,845,1270,1239,1416,1094,1367,1142,1046,1207,1106,1218,1303,1352,1433,1273,1288,1350,1299,1258,1306,1362,1364,1501,1455,1036,1020,1120,1011,1331,1093,1072,1164,1291,1048,1248,1232,1219,1264,1136,1369,1232,1620,1156,1310,1319,1377,1091,1272,1505,1399,1273,1253,1252,1266,1466,1126,1356,1282,1405,1193,1090,1254,1014,1307,1101,1153,899,1023,1395,1366,1147,901,1412,1098,1541,1313,1269,1102,1231,1282,1273,1232,1311,1642,1425,1086,1456,1457,1437,1177,1235,931,1075,1159,1340,1135,1098,1226,1165,1192,1435,1090,1231,1333,1370,1225,1533,1170,1334,1224,1505,1181,1261,1248,1448,1288,1342,1245,990,1305,1184,1150,1261,1294,1279,996,1307,1198,1193,1179,1279,1461,1439,1372,1391,1529,1268,1361,1234,1226,1388,1254,1296,1367,1208,1280,1238,1364,802,1350,1564,1254,1029,1002,1099,1088,1235,1328,1289,793,1198,1414,1401,1107,1312,1097,1354,1258,1154,1517,1194,1450,1409,1340,776,1044,1305,1110,1023,1154,1208,1018,1406,1216,962,1189,1220,1009,1250,1169,1264,1167,1322,1306,1344,1226,1208,1139,1234,1436,1442,1281,1438,1085,1009,1140,1161,1164,1394,1236,1131,1509,1361,1174,1159,1248,985,1102,1172,1103,1310,1083,1306,1381,1302,1392,1395,1230,1343,1138,1151,1294,1382,1452,1426,1378,1343,1269,1107,1210,972,1410,1246,1125,1231,1368,1042,1218,1424,1120,1431,1496,1179,994,1432,1257,1109,1206,977,1245,1285,1393,1579,1475,1272,1066,1394,1393,1385,1286,1113,968,1158,1126,1109,1156,1122,1276,1078,1260,1064,1321,1352,1237,1196,1250,1296,1404,1272,1404,1369,1298,1265,1226,1205,1302,1245,1377,1143,1279,1367,1268,1047,1058,1286,1108,1147,795,1183,1107,802,1373,1325,1296,1243,1237,1069,1630,1420,1082,1455,1335,1030,1177,1087,1125,1319,1317,1280,1044,1156,1135,1018,1354,1260,1385,1118,1420,1070,1179,1222,1152,1318,1227,1282,745,1331,1584,1342,1134,1254,1015,1401,1151,1294,949,1165,1278,1233,1227,1206,1360,1081,1134,1186,1129,1064,1241,1182,793,1390,1316,1193,1542,1391,1427,1099,1394,1185,1224,1238,1215,1272,1378,1430,1349,1113,1087,1075,1222,802,1224,1076,986,1341,1108,1229,1130,1287,1118,1112,1297,1112,1395,1398,1269,1291,1238,1310,1486,1338,1381,1339,1238,1185,1225,937,1039,1192,1389,1083,1182,1252,966,1244,1235,1019,1286,1122,1026,1390,1461,1197,973,1501,1473,1394,1351,1418,1185,1355,1473,1406,1008,1197,980,1112,1254,994,1056,1174,1237,952,925,1112,1164,1127,1205,1136,930,1350,1153,1511,1338,1127,1322,1306,1354,1331,1334,957,1296,1302,1271,1419,1340,846,1064,1139,1180,1091,1109,1268,1060,1218,1008,1427,1387,1098,1129,1317,1196,1273,1149,1395,1305,1320,1243,1364,1288,937,1299,1233,1463,1092,1232,1239,1158,1319,1237,985,1415,1319,1088,1246,1339,1073,1133,1182,1302,1041,1540,1358,1318,1426,1343,1116,1265,1285,1414,1415,1401,1452,1266,1751,1200,931,987,1214,991,1073,1108,949,1017,1530,1209,992,963,1316,1267,1594,1095,1280,1201,1129,1343,1214,1375,1492,1221,1054,1124,1264,1235,1192,1175,1358,1025,862,897,1057,1110,1160,1180,1216,1385,1200,1143,1219,1290,1135,1500,1041,1291,970,1186,1155,1198,1246,1107,1342,1118,1220,1317,1396,1201,1219,1220,908,1213,1246,1317,1292,1285,1161,1062,1085,1211,1180,1300,1399,1103,1466,1243,1431,1268,1325,1450,1265,1207,1285,927,1290,1307,1197,1281,1461,1137,1057,1111,1313,1116,1266,1149,1272,1398,1011,1360,943,1368,1373,1479,1094,1228,1100,1184,1522,1398,1433,1099,1207,1430,1065,1412,1448,1357,1047,1175,943,1121,1205,1131,1057,1190,1264,1092,1196,1008,1274,1206,1328,1134,1102,1120,1453,1316,1577,1305,1198,1408,1465,1194,1253,1341,1340,1259,1259,950,1377,1233,1049,1171,1102,1377,1246,1207,884,1103,1468,1319,1191,1205,1531,1063,1230,1132,1194,1280,1350,1278,1364,1180,1552,1230,1086,1006,1105,1514,1133,1119,1172,996,1040,1204,1435,1228,1187,1112,1175,1456,1303,1376,1333,1299,1203,1210,1307,1221,1352,1136,1550,1309,1416,1172,1162,864,906,1244,1334,1142,1274,1346,1410,1246,1382,1196,1096,1109,1288,1222,1270,1338,1133,1214,1362,1240,1165,1385,1200,1232,1288,1364,1439,1547,1338,1228,1318,1367,814,1339,1169,1393,1363,1059,1102,1332,1148,1309,1102,1161,1207,1102,1154,1113,1196,1217,955,1086,1396,1053,1405,1286,1135,1505,1142,1439,1119,1359,1149,1201,1275,1162,1174,1328,1049,1139,1080,1027,1117,974,1183,1114,1194,1088,1287,1334,1286,1081,1084,1235,976,1411,1143,1286,1239,950,1313,1134,1015,1275,1100,1227,1183,1134,1035,1068,1111,1012,1043,1111,1464,1414,1614,1600,1307,1321,1251,1315,1376,1306,1260,1505,1188,1169,1302,1125,1131,1284,1134,975,1334,1116,1107,1239,1277,1258,1088,1359,1230,1176,1611,1017,994,1077,1221,1261,1080,1058,1212,1244,1250,1340,1331,1221,1269,1230,1192,1096,1258,1521,1314,1297,1371,1298,945,1393,1052,1258,1160,1129,1221,1081,1218,1191,1277,1459,1308,1281,1492,1118,1143,1189,1267,1261,1222,1482,1375,1311,1337,1134,990,1088,1192,1183,1227,1261,984,981,1142,957,1567,1067,1234,1073,1354,1091,1259,1320,1358,1389,1207,997,1186,1581,1505,1377,1343,1333,1236,1046,990,1410,1174,1043,1493,1277,1468,1268,1392,1007,1120,1245,1187,1157,1195,940,1470,1083,1080,1399,1294,1240,1312,1119,1192,1076,1069,1318,1410,1161,1166,1156,1079,1153,1251,1181,1266,1196,1453,1042,1273,1141,1384,1443,1155,972,933,1220,1268,1317,1425,1247,1238,1341,1413,1130,1405,1144,1385,1321,1246,1203,1114,1203,1018,1166,1154,1315,1163,1093,1253,1384,1394,1218,1390,1373,1432,1410,1147,1025,1175,1138,1123,1225,1116,1255,1264,1266,1188,1055,1503,929,1155,1252,1055,1213,1307,1095,1158,1308,1544,1330,1448,1201,1180,1563,1331,1137,1263,1316,984,1303,900,1339,1213,1055,1236,1499,837,1183,1343,1018,1461,1291,1012,1187,1076,1235,1094,1108,1404,1176,1301,1225,1175,1405,1216,1363,1160,1204,1226,1175,1298,1280,1397,1322,887,1530,1098,1024,1440,1473,1329,1454,1509,1143,1209,1277,1405,1194,1125,1332,1259,1375,1188,1299,995,1452,1376,1159,1132,1152,1242,1221,1243,1145,1019,1248,1301,1182,1008,1141,1116,1074,1285,1070,1357,1163,1305,1191,1289,1010,1337,1141,1448,1252,1144,1336,1336,1477,1052,1211,1344,1173,1375,1143,1157,1335,1142,1282,1082,1136,1076,1127,1307,1279,1355,1365,1212,1398,1292,1359,1110,1057,1133,1389,1119,1070,1247,1539,1029,964,1050,1403,1061,1334,1078,1002,1411,1006,941,1159,1142,1260,1227,1204,1252,1073,1177,1335,1268,1256,1424,1385,1041,1427,1229,1450,1441,1314,1223,1185,998,1281,775,1175,1257,1072,1441,1120,1228,1232,1238,932,1285,1272,1312,964,1207,1206,1228,1099,1155,1306,1186,1254,1418,1110,932,1401,1144,1413,1277,1096,1199,1382,1138,1436,1336,1157,1322,1317,1506,1140,1156,1232,1401,1090,914,1394,1254,1397,1219,1170,1216,1326,1478,1365,1072,1214,1226,1552,1041,1255,1416,1040,1042,1230,1453,1004,1090,1265,819,1535,1015,1305,1033,1092,1153,1175,1230,1196,1169,1383,1172,1157,1466,1351,1354,1426,1158,1483,1470,1169,1139,1078,1182,1465,1169,1034,1142,1202,1249,1275,1215,1493,1168,1369,1142,989,1302,1025,1140,1336,1242,1487,1240,1212,1337,1294,1073,1179,1158,1556,1068,1160,1404,1091,1368,995,1140,1085,1126,1144,1253,1259,1159,1339,1033,1326,1027,1188,1258,1236,1263,1380,1197,1170,1476,1086,1348,1245,1306,1069,1403,1426,1416,1177,1152,1257,1097,1402,1404,1309,1166,1017,934,1146,1110,995,1201,1350,1126,1004,1266,1537,1464,1134,1298,1399,1105,1200,1346,1118,1327,1276,1299,1043,1138,1238,1135,1121,1066,1261,1054,1262,1212,1132,1103,1001,1294,1305,1030,1274,1383,1145,1048,1220,1404,1272,1165,1405,905,1180,1366,1121,1200,1196,1153,1271,1134,1163,980,1284,1171,1156,1305,1179,1209,1200,1264,1126,1363,1201,1420,1291,1274,1332,1261,1386,1427,1273,1247,1347,1479,1168,1285,1115,1247,1111,1166,1387,1225,1206,1205,1128,939,1194,940,1185,1175,1006,1370,1570,1130,1309,1394,1348,1237,1245,1228,1112,1186,1323,1193,1099,1180,1066,1339,1104,1252,1348,1362,1241,1137,1144,1286,1041,1289,1239,1065,1303,1173,1528,1129,1258,1393,1100,1196,1141,1477,1343,1153,1252,1164,1220,1497,1076,1019,1202,1153,959,1113,1097,1259,1164,1204,1544,1386,1061,1100,1426,1250,1200,903,1138,1294,1296,1577,1278,1207,1227,1257,1204,1489,1161,1019,1311,1207,1286,1089,1067,1063,1139,1080,999,1343,802,1266,959,1165,1154,1386,1326,1083,1295,1100,1221,1475,1146,1272,1270,1577,1109,1475,1236,1260,1262,1077,1009,1364,983,1119,1302,1346,1122,1258,1442,1053,1171,1339,1011,1241,1352,1169,1276,1094,1165,1383,1103,1253,1224,1169,1154,1389,1080,1008,1358,1188,1117,1102,1221,1267,1066,1346,1384,1126,852,1348,1473,1189,1177,1249,1257,1316,1182,1395,1499,1217,1289,1198,1122,1386,1281,1192,1194,1009,1295,1099,1133,1424,1208,1223,1120,1219,1051,1410,1201,1165,1250,1199,1106,1308,1571,1424,1536,1083,1175,1318,1084,1220,1303,1333,1067,1385,931,1241,1263,1235,1325,787,1127,1056,1054,944,1158,1286,1362,1098,1006,1177,1527,1199,1313,1358,1331,1210,1188,1182,1302,1062,1204,1186,1166,1274,1287,1282,1445,1134,1191,755,1472,1171,1075,1035,1369,1188,1271,1116,839,1332,1301,1139,1261,1220,1051,1218,1224,1176,1381,1279,1294,1366,1172,1571,1005,1147,1120,1257,1187,1085,1375,1172,1455,862,1281,1356,1399,819,1131,1236,1109,1227,1012,1255,1302,1382,1270,1188,1577,1168,1195,1139,1292,1232,813,1061,1114,952,1378,1063,1320,1059,1029,1303,1281,1207,1077,1011,1416,1151,1298,1078,1319,1176,1134,1375,1272,1398,1393,1193,1462,1313,1440,1073,1137,1180,1252,989,1138,1185,1345,1193,767,1098,1166,1360,725,1116,1068,1403,1097,1273,1383,1285,1224,1285,1256,1582,1086,1413,1431,1191,1147,1493,1266,1145,1427,1380,1127,1177,990,1170,1130,1151,1182,1015,1255,1323,1112,1251,1274,1243,1299,1415,1439,1421,1207,977,1161,1151,1383,1343,1268,1237,1127,1130,1280,1132,1399,1107,1299,1123,964,1147,1196,1344,999,1074,1341,1446,1398,1274,1251,1193,1157,1300,1308,1258,1186,1065,1157,1469,1177,1449,1147,1180,1242,1360,1212,914,924,1171,990,1319,1424,1321,1227,1160,1025,1321,1283,1293,1296,1270,1364,1365,1179,1028,1101,1350,1098,1064,1245,1324,1271,1249,1277,1308,1100,1131,1362,1205,1100,1306,1154,1415,1108,1154,1240,1369,1172,1192,1358,1264,1429,1214,1235,1279,1250,1228,1153,1339,1248,1295,1375,1134,839,1359,1162,1100,1108,974,1174,1133,1305,972,1169,1299,925,1409,1080,1485,1515,996,1223,1146,1211,1333,1198,1144,1338,1180,1417,1344,1312,1298,988,1352,1246,1265,1294,1149,1304,1221,1411,1512,1399,1179,1175,1214,1414,1377,1178,1327,1164,1489,1499,1227,1307,1319,1164,1163,1178,1274,1265,1121,1327,1125,989,1128,1356,1348,1046,1266,1287,1151,1120,1287,936,1321,1123,1381,1248,906,1078,1236,1419,1167,1070,1260,1511,1315,1014,1145,1326,1193,1236,1503,1186,1076,1258,1429,1204,1467,1243,1343,1372,1295,1288,1055,1255,1212,1262,1095,1235,1233,1429,1403,1028,1217,1183,1292,1550,1344,1252,1248,1052,1335,1349,1197,1148,1401,1209,1282,1160,1150,1402,1287,1158,1360,1187,1499,1231,1074,1312,1255,1300,1288,1321,1181,1372,1354,1340,1407,1189,1127,1426,1144,1147,1162,1215,1137,1079,1286,1160,1079,1201,1013,1174,1298,899,1308,1251,1346,1331,1558,1195,1214,1241,1174,1320,1297,1458,1178,1311,1192,1256,1259,1040,1331,1238,999,1447,998,1381,1518,1146,1175,1147,1374,1385,1002,1359,1100,1172,1133,1260,1305,1294,1064,1291,1262,1317,1349,1375,1135,1147,894,780,1409,1184,1309,1149,1300,1267,1144,1293,1283,1099,1049,1395,1408,1389,1292,1501,1349,1113,1448,1401,1473,964,1411,1181,1241,1248,1211,1109,1185,1122,1149,1175,1125,1303,1136,1459,1262,1240,1157,1122,1255,1152,1339,1327,1340,1225,1236,1133,1327,1333,1129,1128,1155,1185,1364,1160,1084,1361,1056,1210,1109,1434,1067,1149,1195,1178,1256,1439,1122,1149,1251,1449,1235,1298,1172,1118,1147,1540,1333,1250,1260,1134,1114,1239,1321,1216,850,895,1402,1464,1186,1218,1098,1348,1143,1358,943,1245,1212,1301,1119,1408,1134,1352,1011,1381,1367,1426,1129,1162,1394,1307,1298,1144,1145,1249,1123,1243,1031,1240,1269,1164,1256,1044,1352,1239,1278,1093,1190,1202,1366,1190,1324,1539,1433,1146,1371,1176,1206,1261,1382,1110,1356,914,1394,1195,1100,1310,1117,1274,1271,1008,1092,1278,1196,1046,871,946,1376,1112,1150,1449,1210,1337,1337,1348,1590,1287,1445,1400,1210,1362,1376,1317,1216,1195,1119,1140,1083,1069,1337,1093,1383,959,1328,1163,1053,1270,1369,1387,1263,1362,1247,1137,1382,1745,1305,1328,1384,1410,1283,1332,1202,1059,965,1013,1327,1231,1131,965,1147,1204,1332,1251,1059,1101,1138,1151,1125,1131,1267,1323,1396,1363,1483,1299,1318,1392,1289,1590,1009,1287,1142,1022,1076,1326,832,1384,1354,1141,1062,1054,1172,913,1151,1242,1217,1260,1115,1343,1285,1212,1231,1189,1162,1494,1318,1403,1420,1359,1328,999,1373,1142,1446,1413,1063,1096,1449,1014,1072,1026,1205,1202,1321,1059,1122,704,1346,1403,1364,1199,1263,1485,1271,1271,1570,1207,1309,1376,1357,1169,1260,1272,865,1223,1274,989,1161,1160,1412,1368,1354,1193,1135,1242,1431,1030,1190,1351,1223,1184,1367,1298,1197,1363,1258,1264,1400,1345,1088,1123,1355,1327,1268,1461,1198,1175,1188,1081,1192,1334,1099,1158,1183,1207,1167,1125,1281,1153,1572,1220,1064,1160,1441,1042,979,1296,1095,1202,1622,1086,1219,1284,1400,1038,1218,1313,855,1171,1039,1253,1162,1422,1246,1278,1227,1077,1305,1165,1238,1370,1082,1103,1269,1377,1252,1257,1305,1418,1431,1172,1146,1454,1364,982,1139,1367,1220,1255,1216,1138,1331,1339,1254,1063,1138,1225,1233,1227,1227,1225,1135,1513,1384,1235,1378,1430,1399,1231,1336,1398,1144,1239,1177,1408,873,1139,1311,1195,875,1251,1387,1245,1356,1380,1080,1409,996,1245,1163,1363,1475,1177,1278,1374,1386,1014,1326,1077,973,1416,1075,1153,1406,977,1141,1230,1339,1332,1033,1209,1088,1181,1231,1329,927,1346,1407,1243,1283,1458,1248,1524,1412,1093,1334,1421,1391,1234,1123,1254,1281,1260,1119,1062,1323,1445,1183,994,1275,1131,1193,976,1255,1296,1012,1295,1292,1292,1378,1012,1448,1269,1176,1136,1143,1357,1300,1332,921,1199,1200,1049,1383,1259,1118,1258,1176,1001,1134,1357,1314,1419,1184,1158,1287,1380,1172,1295,1309,1317,1246,1216,1327,1234,1161,1223,1459,977,1160,1249,1473,1419,1375,999,1016,1155,1354,1136,1214,1136,1131,1360,1190,1231,982,1136,1268,1425,1351,1213,1051,1287,1231,1318,1055,997,1236,1101,1228,1359,1160,1345,1132,1161,1270,1567,1264,1121,1137,1345,1454,1258,1269,1202,907,1091,1271,1106,1345,1156,1396,1119,1175,1214,1431,1200,1380,1417,1433,1520,1051,1192,1188,1136,1175,1183,1163,1117,1360,1085,1288,1319,1437,1195,1306,1084,1077,1029,1257,1248,1167,1284,1459,1242,1655,1227,1069,1326,1320,1173,1317,1245,1112,1048,1306,1156,946,1176,1357,1161,1151,1136,1129,1373,1012,1208,1276,916,1184,1359,1306,1231,1210,1143,1118,1293,1236,1390,1264,962,1178,1374,1501,1352,1200,1244,1014,1401,1086,1202,1051,1161,1196,976,1085,1153,1268,1278,1279,1618,1271,1361,1337,1392,1360,1229,1218,1176,1409,1197,1340,1284,1278,1158,1092,1030,1303,1233,1172,1194,1065,1276,1082,1050,1318,1227,995,1332,1359,1232,1140,1165,1180,1113,1466,1304,1217,1244,1239,1259,1302,1265,1280,1273,1201,1026,1065,1043,1206,1248,1060,1315,1240,1112,1082,1100,1480,1124,1230,1372,1046,1072,1434,1433,1055,1183,1120,1009,1436,1320,1637,1351,1439,1021,1042,1302,1340,992,925,1200,1171,1085,1300,1073,1015,1208,1117,1213,1313,1207,1438,1259,1294,1128,1380,1306,1246,1299,1147,1259,1323,1364,1323,1203,1308,1214,1292,1231,1196,956,1114,1165,1331,1304,962,1023,1062,1208,1249,951,1272,1246,1188,1101,1161,1115,1035,1232,1124,1296,1312,1403,1263,1248,1155,1357,1236,1263,1160,1128,1016,1388,1149,950,1202,1190,1093,1081,1054,1540,1436,1287,1539,1326,1166,1307,1326,1467,1421,1224,1321,1130,1059,1092,1237,1228,1326,1167,940,1150,1095,1065,1091,1177,1234,978,1374,1115,1283,1249,1238,1186,1183,1191,1194,1092,1219,1447,1509,1195,1299,1575,1209,937,1051,1318,1312,1228,1211,1302,1089,1390,1095,1167,1212,1271,1357,1143,1267,1097,1509,1501,1256,1373,1208,1272,1142,1234,1342,1331,1343,1549,1338,1184,1255,1273,1433,1054,1293,1102,1529,934,1102,1035,1343,1111,1136,882,1233,1616,1380,981,1408,986,1164,1144,1390,1132,1353,1325,1141,1375,1038,1221,1070,846,1144,1376,1148,1158,1239,1112,1010,1036,1138,1244,1369,1212,1302,1144,1295,1346,1365,1305,1222,1445,1251,1238,1330,1256,1353,1265,1233,991,1169,1027,1416,1197,1221,1016,1284,1237,1295,1414,1366,1236,1397,917,898,1072,1265,1311,1157,1292,1166,1327,1322,1078,1200,1356,1083,1293,1078,1206,1368,1225,1310,1061,1281,1285,1332,1075,1041,893,1298,917,1367,1194,1491,1412,1321,1315,995,1294,1351,1363,1392,1220,1050,1036,1564,1221,1151,1129,1262,1100,1208,1115,1074,1465,1197,1071,1071,1337,1273,1413,1230,1013,1431,1313,1167,1149,1041,1098,1337,1263,1350,1428,1255,1310,1361,1261,1223,1080,1266,1059,1181,1006,1055,1274,1150,940,1144,1135,1332,1418,1168,1407,1254,1279,1316,1253,1326,1158,1100,1424,1263,1229,1292,1495,1497,1280,1225,1172,1309,1127,1052,1188,959,1207,1340,1301,966,1103,1355,1188,1191,1185,1250,1259,1117,1614,1220,1343,1524,1364,1044,1071,1212,1356,1114,1212,1327,1382,1245,1188,1266,1143,1552,1065,1286,994,1314,1032,1319,1187,1129,1250,1156,1211,1149,1195,1526,1112,1362,1154,1360,1359,1341,1225,1413,1323,1378,1098,1181,1257,1015,1426,1341,1160,976,1141,1164,1270,1163,1168,1070,1372,1198,1360,1054,1017,1285,1290,1029,1471,1534,1266,1192,1563,1192,1200,1285,1003,1016,1421,1000,1178,1072,1342,945,1328,1230,1254,1188,1425,1070,1078,1159,1298,1308,1334,1245,1363,1441,1424,1283,1228,1287,1263,1345,1342,1197,1272,1106,1157,1260,1397,1273,1563,1018,1455,1205,1160,1000,1335,1293,875,1208,1103,1310,1387,1229,1183,1233,1226,1358,1360,1236,1308,987,1222,1468,1121,1117,1233,1116,1010,1389,994,1040,1479,1256,1204,1333,1292,1051,1215,1207,1380,1096,1573,1382,1167,1122,870,1227,1250,1263,1302,1343,1237,1221,1217,1378,1236,1278,945,1309,1242,1260,1271,1149,1132,1290,1198,1087,1334,1125,1355,1277,1517,1241,1058,1210,1362,1242,1116,1515,1135,1298,1225,1360,1218,1163,1298,1282,1089,1265,1151,1020,1336,1310,1219,1108,1176,1227,1224,1133,1207,1366,1315,1048,1268,1358,1176,1310,1547,1158,1226,1421,1370,993,1427,1128,1101,1113,1103,1275,1101,1270,976,1115,1165,1338,1104,1158,1140,1170,1363,1126,1300,1250,1148,1550,1303,1279,1166,1437,1111,1459,1484,1133,995,1045,1164,1213,1460,1068,1174,1109,1088,1442,1045,1120,1291,1176,1172,981,1288,1191,1544,1453,1363,1407,1212,1402,1022,1223,1386,1231,1132,1245,1193,1051,1071,1167,1195,1409,1201,1129,906,1281,1084,1086,1035,1196,1214,1273,1093,1448,1471,1405,1448,1372,1235,1530,1244,1223,1141,1155,1159,1368,1355,1246,1273,1122,968,1004,875,1333,1218,1269,1641,1132,1197,1110,1149,1086,1393,1022,1314,1310,1072,1333,1102,1297,1202,1520,1474,1110,1454,1374,1299,1055,745,1096,1374,1080,1164,1170,1195,1263,1306,952,980,1216,1011,1187,1429,1302,1266,1303,1131,1449,1143,1386,873,937,1186,1250,1582,1073,1008,1180,1095,1213,1422,1147,1243,1141,1155,1149,1154,1086,1243,1338,1035,1260,1362,1036,1257,1326,1072,1285,1450,1203,1095,1342,1088,1179,1578,1205,974,1358,1335,1434,1127,1387,1193,1499,984,1012,1135,993,964,1331,1043,1286,1095,1324,1164,1183,1329,1348,1188,1304,1305,1490,1140,1380,1352,1276,1104,1301,1274,1108,867,995,1262,949,1230,1075,1165,1334,1042,1249,1104,1248,1252,1402,1020,1065,948,1217,1339,1060,1346,1312,1017,982,1078,1093,1150,1316,1389,1312,1004,1036,1066,1402,1250,1164,974,1089,1210,893,1284,1471,1340,1352,1427,1334,1261,1108,1204,1254,1204,1708,1411,1308,1244,1211,1217,1455,1051,1333,1299,1152,1218,1088,1484,1141,1215,1269,1334,1064,1253,1001,1366,1498,1456,1352,1179,1506,1324,1225,1001,1552,1352,1230,1243,1305,1284,1281,1098,1199,1094,1034,1389,1294,1045,1400,1180,1371,1184,1141,1093,1237,1335,1277,1259,1189,1355,1152,1546,1034,1193,1417,1323,1125,903,1175,1373,1061,1123,1241,1293,1179,1084,1024,1178,998,1185,1435,1039,1151,1116,1344,1197,1478,1100,1148,1235,1224,1177,1210,1223,1318,1336,1112,1314,1375,1393,1328,1429,1185,1293,1270,1184,930,1091,1173,1352,1244,1239,1161,965,1429,1331,1117,1529,1060,1320,1051,1194,1125,1475,981,1427,1364,1185,1122,1382,1250,1449,1172,1249,1298,1135,1269,897,1068,1008,1088,1106,1290,1009,1039,1127,1558,1371,1245,1189,1168,1146,1295,963,1217,992,1316,1269,1358,1212,1283,1114,1446,1043,1202,1251,1019,1076,1071,1270,1001,1184,1509,755,1117,1313,1419,1320,1208,1163,1179,1386,1235,1281,1106,1074,1524,1356,1276,1202,1316,1508,1368,1244,1117,1034,1321,1332,1257,1103,1197,1120,1303,1156,1116,1042,1428,1462,1170,1233,1228,1457,1222,1241,1256,1399,1267,1638,1265,1147,1285,974,1138,1245,1271,1205,1268,1185,1368,1301,1151,1274,1201,1223,1216,1415,1416,1379,1145,1352,1171,1511,927,1204,1165,1125,1256,1184,1357,1344,1110,923,1335,1233,903,1317,1167,1024,1096,1266,1374,1262,1148,1225,1484,1178,1400,1475,1120,1527,1065,1103,1123,1234,1123,1295,1471,1222,1476,1163,1291,1196,1246,1263,1137,1231,1234,1214,1377,1446,1135,1344,1161,1059,1270,1385,1177,1258,1167,1294,1312,1309,1498,1111,1382,1123,1077,932,1204,1222,978,1222,1185,1023,1241,1269,1149,1094,1124,1228,1171,1173,1175,1048,1172,992,1418,1327,1552,1261,1446,1078,1431,1065,1388,1011,1305,1270,1158,1262,1249,1084,1264,1163,1357,1049,1465,1056,1240,1252,1225,1186,1139,1175,1338,1200,1262,1185,1218,1151,1067,1105,1466,1474,1373,1018,1282,1177,1464,1297,1255,1156,1446,1111,948,1021,1277,1319,1367,1229,1084,1080,1251,1287,1350,1238,1346,1097,1248,993,1175,1350,1238,1330,1386,1283,1320,1337,1420,1279,998,1272,1265,1066,1061,1264,1130,1095,1014,1110,1258,1133,1246,1344,1319,1025,1414,1197,1319,1374,1526,1376,1356,1178,1073,1260,1345,1311,1339,1198,1268,1402,1135,1010,1225,1360,1500,1227,1408,1028,1142,929,1441,1186,1318,1207,1302,1367,1207,1348,1156,1265,1381,1117,1574,1311,1348,1257,1170,1271,1216,1258,1349,1324,1045,1248,1457,1257,1199,1127,1330,1270,1224,1391,1340,1051,1221,1050,1113,1273,1108,999,1260,1104,1369,1293,1321,1204,1176,1142,1125,1223,1149,1107,1097,1103,1266,1029,1105,1189,1182,1156,1184,995,1190,1272,1359,1465,1481,1161,1235,1250,1270,1000,1354,1221,1122,1081,1349,1286,1241,1099,1131,1082,1303,1267,1152,1083,1165,1076,1029};
//static double InputTestData[TEST_DATA_COUNT] = {
//		1181,
//		1421,
//		1518,
//		1394,
//		1223,
//		1305,
//		1300,
//		1100,
//		1157,
//		1054,
//		1436,
//		1137,
//		1134,
//		1305,
//		1066,
//		1059,
//		1219,
//		1372,
//		1037,
//		1266,
//		1102,
//		1127,
//		 977,
//		1387,
//		1496,
//		1029,
//		1261,
//		1337,
//		1326,
//		1346,
//		1314,
//		1170,
//		1224,
//		1099,
//		1544,
//		1144,
//		1071,
//		1276,
//		1402,
//		1204,
//		1270,
//		1238,
//		1066,
//		1325,
//		1076,
//		1136,
//		1262,
//		1215,
//		1275,
//		1287,
//		1088,
//		1006,
//		1422,
//		1308,
//		1201,
//		1443,
//		 966,
//		1254,
//		1244,
//		1507,
//		1283,
//		1364,
//		1494,
//		1069,
//		 945,
//		1236,
//		1183,
//		1223,
//		1177,
//		 986,
//		1258,
//		1176,
//		1337,
//		1376,
//		1308,
//		1045,
//		1098,
//		1350,
//		1017,
//		1176,
//		1120,
//		1123,
//		1116,
//		1161,
//		1313,
//		1138,
//		 897,
//		 989,
//		1422,
//		1332,
//		1199,
//		1305,
//		1356,
//		1202,
//		1309,
//		1268,
//		1261,
//		1274,
//		1051,
//		1310,
//		1023,
//		1109,
//		1164,
//		1281,
//		1356,
//		1231,
//		1073,
//		1207,
//		1373,
//		1156,
//		1243,
//		1453,
//		1208,
//		1451,
//		1313,
//		1249,
//		1183,
//		1397,
//		1269,
//		1043,
//		1232,
//		1230,
//		1252,
//		1386,
//		1480,
//		1303,
//		1419,
//		1084,
//		1343,
//		1318,
//		1361,
//		1358,
//		1025,
//		1277,
//		1350,
//		1049,
//		1195,
//		1133,
//		1106,
//		1371,
//		 953,
//		1129,
//		1300,
//		1395,
//		1520,
//		1220,
//		1335,
//		1301,
//		1113,
//		1400,
//		1242,
//		1395,
//		1111,
//		1287,
//		1240,
//		1528,
//		1422,
//		1208,
//		1009,
//		1315,
//		1261,
//		1456,
//		 941,
//		1327,
//		1149,
//		1345,
//		1064,
//		1129,
//		1173,
//		1259,
//		1535,
//		1285,
//		1313,
//		1357,
//		1074,
//		1200,
//		1181,
//		1104,
//		1409,
//		1295,
//		1450,
//		1388,
//		1235,
//		1397,
//		1305,
//		1724,
//		1310,
//		1307,
//		1153,
//		1111,
//		1378,
//		1124,
//		1205,
//		 999,
//		 970,
//		1349,
//		1307,
//		1147,
//		1381,
//		1180};

uint32_t elementCount;
uint32_t rawAdcValue;
uint32_t decimateCount;
uint16_t placeIndex;
uint16_t powerMaxIndex;
double threshold;
double scaledAdcValue;
double powerTemp;
double playerTemp;
uint32_t hitCounts[FILTER_QUANTITY];
int32_t playerHit;

bool detector_hitDetectedFlag;
bool detector_hitDetectAlert;
bool detector_test_mode;
//double power[FILTER_QUANTITY][2];  // [power][player]
double power[FILTER_QUANTITY];
void detector_init() {
	printf("zoinks!\r\n");
	filter_init();
	elementCount = 0;
	rawAdcValue = 0;
	playerHit = 0;
	decimateCount = 0;
	detector_test_mode = false;
	detector_clearHit();
	detector_hitDetectAlert = false;
	for (int i = 0 ; i < FILTER_QUANTITY ; i++) {
		hitCounts[i] = 0;
		power[i] = i;
		filter_computePower((uint16_t)i, true, false);
	}
}

//void detector_hitDetectAlgorithm() {
//	// We sort the normalized power values with an insertion sort
//	for( int k = 1 ; k < FILTER_QUANTITY ; k++) {
//		placeIndex = k;
//		while((placeIndex > 0) && (power[placeIndex - 1] > power[placeIndex])) {
//			powerTemp = power[placeIndex];
//			power[placeIndex] = power[placeIndex-1];
//			power[placeIndex-1] = powerTemp;
//			placeIndex--;
//		}
//	}
//
//	// Multiply the median value with a fudge factor
//
//	threshold = FUDGE_FACTOR * power[4];
//
//	if(power[9] >= threshold) {
//		detector_hitDetectAlert = true;
//	}
//
//	if(detector_hitDetectAlert) {
//		// Start the lockoutTimer
//		lockoutTimer_start();
//
//		// Start the hitLedTimer
//		hitLedTimer_start();
//		// increment detector_hitArray at the index of the frequency of the IIR-filter output where you detect the hit
//		hitCounts[playerHit] += 1;
//		// Set detector_hitDetectedFlag to true
//		detector_hitDetectedFlag = true;
//	}
//
//}

void detector_hitDetectAlgorithmTest() {
	// We sort the normalized power values with an insertion sort
	for( int k = 1 ; k < FILTER_QUANTITY ; k++) {
		placeIndex = k;
		while((placeIndex > 0) && (inputTest[placeIndex - 1][0] >= inputTest[placeIndex][0])) {
			powerTemp = inputTest[placeIndex][0];
			playerTemp = inputTest[placeIndex][1];
			inputTest[placeIndex][0] = inputTest[placeIndex-1][0];
			inputTest[placeIndex][1] = inputTest[placeIndex-1][1];
			inputTest[placeIndex-1][0] = powerTemp;
			inputTest[placeIndex-1][1] = playerTemp;
			placeIndex--;
		}
	}


	// Multiply the median value with a fudge factor

	threshold = FUDGE_FACTOR * inputTest[4][0];

	if(inputTest[9][0] >= threshold) {
		detector_hitDetectAlert = true;
		playerHit = inputTest[9][1];
	}
	printf("max: %lf and threshold: %lf\r\n",inputTest[9][0],threshold);
	if(detector_hitDetectAlert) {
		// Start the lockoutTimer
		lockoutTimer_start();

		// Start the hitLedTimer
		hitLedTimer_start();
		// increment detector_hitArray at the index of the frequency of the IIR-filter output where you detect the hit
		hitCounts[playerHit] += 1;
		// Set detector_hitDetectedFlag to true
		detector_hitDetectedFlag = true;
	}

}

void detector() {
	// Here we query the adcQueue to see how many elements it contains


	// Statement used to activate test mode when detector_runTest is called
	if(detector_test_mode) {
		elementCount = TEST_DATA_COUNT;
	}
	else {
		elementCount = isr_adcBufferElementCount();  //We assign that number to elementCount
	}

	// We use the while loop to keep track of decimation
	while(isr_adcBufferElementCount() > FILTER_QUANTITY) {
		// Repeat the following  steps elementCount times
		for(uint32_t i = 0 ; i <  FILTER_QUANTITY ; i++ ) {
			// Disable the interrupts
			interrupts_disableArmInts();
			// Pop a value from the adcQueue and place it in rawAdcValue

			if(detector_test_mode) {
				scaledAdcValue = InputTestData[i];
				printf("test data activated\r\n");
			}
			else {
				// Scale the integer value contained in rawAdcValue to a double that is between -1.0 and 1.0
				// Save the value to scaledAdcValue
				rawAdcValue = isr_removeDataFromAdcBuffer();
				scaledAdcValue = (double) rawAdcValue;
				// For the ZYBO board we scale by 2048 and shift by 1.
				scaledAdcValue =(scaledAdcValue / DETECTOR_SCALEADC) - DETECTOR_SHIFTADC;
			}
			// Re-enable the interrupts by invoking interrupts_enableArmInts()
			interrupts_enableArmInts();

			//invoke filter_addNewInput(scaledAdcValue)
			filter_addNewInput(scaledAdcValue);

		}
		//perform the decimating FIR filter, IIR filter and power computation for all 10 channels.
		// Invoke the filters after filter_addNewInput() has been called 10 times

		filter_firFilter();
		for(int j = 0 ; j < FILTER_QUANTITY ; j++) {
			filter_iirFilter((uint16_t)j);
			filter_computePower((uint16_t)j, false, false);
		}

		// if the lockoutTimer isn't running run the algorithm.  Otherwise if a hit is detected:
		if (!lockoutTimer_running()) {
			// We implement the hit detection algorithm to see if we register a hit
			//	 filter_getNormalizedPowerValues(power, &powerMaxIndex);
			for(int i = 0 ; i < FILTER_QUANTITY ; i++) {
				power[i] = filter_getCurrentPowerValue(i);	// Store the power
			}

			// We sort the normalized power values with an insertion sort
			for( int k = 1 ; k < FILTER_QUANTITY ; k++) {
				placeIndex = k;
				while((placeIndex > 0) && (power[placeIndex - 1] > power[placeIndex])) {
					powerTemp = power[placeIndex];
					power[placeIndex] = power[placeIndex-1];
					power[placeIndex-1] = powerTemp;
					placeIndex--;
				}
			}


			// Multiply the median value with a fudge factor
			threshold = FUDGE_FACTOR * power[4];

			if(power[9] > threshold) {

				for (int i = 0; i < FILTER_QUANTITY; i++){
					if (power[9] == filter_getCurrentPowerValue(i))
						playerHit = i;
				}

				// Start the lockoutTimer
				lockoutTimer_start();

				// Start the hitLedTimer
				hitLedTimer_start();

				// increment detector_hitArray at the index of the frequency of the IIR-filter output where you detect the hit
				hitCounts[playerHit] += 1;
				detector_hitDetectAlert = true;

				// Set detector_hitDetectedFlag to true
				detector_hitDetectedFlag = true;
				detector_hitDetectAlert =false;  //reset the alert
			}
		}
	}
}



bool detector_hitDetected() {

	return detector_hitDetectedFlag;
}

void detector_clearHit() {
	detector_hitDetectedFlag = false;
}

void detector_getHitCounts(detector_hitCount_t hitArray[]) {
	for(int i = 0 ; i < FILTER_QUANTITY; i++) {
		hitArray[i] = hitCounts[i];
	}

}


void detector_runTest() {
	isr_init();
	interrupts_initAll(false);
	detector_test_mode = true;
	// First we want to do the isolated test of our hit detection algorithm

	bool passTest = true;  // Be optimistic
	// We take our designated test array and assign it values
	for(int i = 0 ; i < FILTER_QUANTITY ; i++) {
		inputTest[i][0] = testDataB[i];	// Store the power
		inputTest[i][1] = i;	// Associate the player to that power value
	}

	// Pass the array through the detector algorithm
	detector_hitDetectAlgorithmTest();

	// For test A, there should be a hit detected.
	if (detector_hitDetectedFlag) {
		passTest = false;
		printf("fail\r\n");
	}

	for(int i = 0 ; i < FILTER_QUANTITY ; i++) {

		if(inputTest[i][0] != expectedDataB[i]) {
			passTest = false;
			printf("%lf vs %lf\r\n",inputTest[i][0], expectedDataB[i]);

		}
	}

	detector_clearHit();	// Reset for test B



	if(passTest) {
		printf("Passed Isolated Test\n\r");
	}
	else {
		printf("Failed Isolated Test\n\r");
	}




	// Comprehensive test
	detector_init();
	detector_test_mode = true;
		detector();

//	for(int i = 0 ; i < FILTER_QUANTITY ; i++) {
//		printf("player %d had %ld hits\r\n",i,hitCounts[i]);
//	}
}




