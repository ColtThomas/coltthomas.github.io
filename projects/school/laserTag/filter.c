/*
 * filter.c
 *
 *  Created on: Feb 7, 2015
 *      Author: coltmt
 */

#include "filter.h"
#include <stdio.h>
#include <stdlib.h>
#include "supportFiles/intervalTimer.h"
#include "histogram.h"
#include <math.h>
#include "supportFiles/utils.h"

#define FILTER_IIRFILTERS 10
#define FIR_FILTER_TAP_COUNT 201
#define FIR_COEFFICIENT_COUNT 201
#define X_QUEUE_SIZE FIR_COEFFICIENT_COUNT  // Sample of 200ms
#define Y_QUEUE_SIZE IIR_COEFFICIENT_COUNT
#define IIR_COEFFICIENT_COUNT 11
#define Z_QUEUE_SIZE (Y_QUEUE_SIZE - 1)
#define EPSILON_NEG -0.000001 // Error tolerance in testing
#define EPSILON_POS 0.000001 // Error tolerance in testing
#define TEST_DATA_COUNT 44
#define FIR_TEST_DATA_COUNT 200
#define OUTPUT_QUEUE_SIZE 2000
static queue_t xQueue;
static queue_t yQueue;
static queue_t zQueue[FILTER_IIRFILTERS];
static queue_t outputQueue[FILTER_IIRFILTERS];
double currentPowerValue[FILTER_IIRFILTERS];
double normalizedArray[FILTER_IIRFILTERS];
// These queues are for debugging purposes
queue_t aSum;
queue_t bSum;

// All of my test data is below
//static double firCoefficients[FIR_COEFFICIENT_COUNT] = {1.18253876945993e-06,6.41366477248988e-06,1.8654049888775e-05,3.90896593467756e-05,6.52008802062904e-05,8.7899458360922e-05,8.99146634834456e-05,4.68449475994845e-05,-6.76819360498934e-05,-0.000272167104106897,-0.000563739415273607,-0.000904060973223367,-0.0012096186640746,-0.00135238675066806,-0.00117617720393054,-0.000531179479054328,0.000675677561447661,0.00242301184387912,0.00452421832275476,0.0066015635848698,0.00810264481692819,0.00837108651682657,0.00677257805711648,0.00286302554109908,-0.00342928702848173,-0.0116471646527685,-0.0207175569355838,-0.0289725335345497,-0.0343002766205705,-0.0344233442244565,-0.0272725621770326,-0.0113982728086862,0.0136569973573384,0.0471036832740554,0.0868337041933357,0.129568479922759,0.171222372666947,0.207434571694398,0.23418604872714,0.248396712786051,0.248396712786051,0.23418604872714,0.207434571694398,0.171222372666947,0.129568479922759,0.0868337041933357,0.0471036832740554,0.0136569973573384,-0.0113982728086862,-0.0272725621770326,-0.0344233442244565,-0.0343002766205705,-0.0289725335345497,-0.0207175569355838,-0.0116471646527685,-0.00342928702848173,0.00286302554109908,0.00677257805711648,0.00837108651682657,0.00810264481692819,0.0066015635848698,0.00452421832275476,0.00242301184387912,0.000675677561447661,-0.000531179479054328,-0.00117617720393054,-0.00135238675066806,-0.0012096186640746,-0.000904060973223367,-0.000563739415273607,-0.000272167104106897,-6.76819360498934e-05,4.68449475994845e-05,8.99146634834456e-05,8.7899458360922e-05,6.52008802062904e-05,3.90896593467756e-05,1.8654049888775e-05,6.41366477248988e-06,1.18253876945993e-06};
static double firCoefficients[FIR_COEFFICIENT_COUNT]={3.4238617549002e-06,2.37432847467417e-06,2.50762230700877e-06,1.82299287516409e-06,-9.20527210925693e-21,-3.09733387546318e-06,-7.28712512904654e-06,-1.19713211075283e-05,-1.61147095629514e-05,-1.83372885204375e-05,-1.71379102092084e-05,-1.12381630707016e-05,1.73125519315036e-19,1.61640877584482e-05,3.54943889172884e-05,5.48126082235058e-05,6.97674416075449e-05,7.54401130259547e-05,6.72797944574347e-05,4.22520609211441e-05,-1.56289098419292e-19,-5.62422483443196e-05,-0.000119259856535374,-0.000178225420341016,-0.000219952508629319,-0.000231000730854225,-0.000200403913506274,-0.000122600754992244,3.98106375599186e-19,0.000155447940752148,0.000322241233843579,0.000471253515312744,0.00056965674209787,0.000586502077034013,0.000499207607236245,0.000299854788537283,-8.50375759818696e-19,-0.000367266094911334,-0.000748992085793621,-0.00107821342051545,-0.00128368279872845,-0.00130237667891402,-0.00109291938750471,-0.000647537991773119,1.58569296028205e-18,0.000772711752988853,0.00155644530774201,0.00221390195857582,0.00260543220468953,0.00261392702493876,0.00216991037924295,0.00127225455202785,-2.64357275471542e-18,-0.00148832983788559,-0.002969810414881,-0.0041861562953617,-0.00488367898721146,-0.00485868563128736,-0.00400104194642247,-0.00232787720933463,4.00129945705147e-18,0.00268440192749023,0.00532095458040227,0.00745328037125027,0.00864397357711596,0.00855239629822954,0.00700679615518491,0.00405756836787393,-5.55580324111477e-18,-0.00464145362870754,-0.00916977887471289,-0.0128087023589046,-0.0148217815401783,-0.0146407332620995,-0.0119828971701254,-0.00693711130232662,7.1272533565536e-18,0.00794936384470573,0.0157399090115148,0.0220576113326825,0.025636636556856,0.02546772862718,0.0209937383183993,0.0122611341492037,-8.48866650362062e-18,-0.0143867903455889,-0.0289327404779338,-0.0413089081710522,-0.0490968154055243,-0.0501008821026437,-0.0426601704239909,-0.0259165769813147,9.41615209228187e-18,0.0338997568539009,0.0735905837487341,0.116064481652093,0.15779459998864,0.195109104240027,0.224596701082746,0.243493212512208,0.25,0.243493212512208,0.224596701082746,0.195109104240027,0.15779459998864,0.116064481652093,0.0735905837487341,0.0338997568539009,9.41615209228187e-18,-0.0259165769813147,-0.0426601704239909,-0.0501008821026437,-0.0490968154055243,-0.0413089081710522,-0.0289327404779338,-0.0143867903455889,-8.48866650362062e-18,0.0122611341492037,0.0209937383183993,0.02546772862718,0.025636636556856,0.0220576113326825,0.0157399090115148,0.00794936384470573,7.1272533565536e-18,-0.00693711130232662,-0.0119828971701254,-0.0146407332620995,-0.0148217815401783,-0.0128087023589046,-0.00916977887471289,-0.00464145362870754,-5.55580324111477e-18,0.00405756836787393,0.00700679615518491,0.00855239629822954,0.00864397357711596,0.00745328037125027,0.00532095458040227,0.00268440192749023,4.00129945705147e-18,-0.00232787720933463,-0.00400104194642247,-0.00485868563128736,-0.00488367898721146,-0.0041861562953617,-0.002969810414881,-0.00148832983788559,-2.64357275471542e-18,0.00127225455202785,0.00216991037924295,0.00261392702493876,0.00260543220468953,0.00221390195857582,0.00155644530774201,0.000772711752988853,1.58569296028205e-18,-0.000647537991773119,-0.00109291938750471,-0.00130237667891402,-0.00128368279872845,-0.00107821342051545,-0.000748992085793621,-0.000367266094911334,-8.50375759818696e-19,0.000299854788537283,0.000499207607236245,0.000586502077034013,0.00056965674209787,0.000471253515312744,0.000322241233843579,0.000155447940752148,3.98106375599186e-19,-0.000122600754992244,-0.000200403913506274,-0.000231000730854225,-0.000219952508629319,-0.000178225420341016,-0.000119259856535374,-5.62422483443196e-05,-1.56289098419292e-19,4.22520609211441e-05,6.72797944574347e-05,7.54401130259547e-05,6.97674416075449e-05,5.48126082235058e-05,3.54943889172884e-05,1.61640877584482e-05,1.73125519315036e-19,-1.12381630707016e-05,-1.71379102092084e-05,-1.83372885204375e-05,-1.61147095629514e-05,-1.19713211075283e-05,-7.28712512904654e-06,-3.09733387546318e-06,-9.20527210925693e-21,1.82299287516409e-06,2.50762230700877e-06,2.37432847467417e-06,3.4238617549002e-06};
static double firInputTestData[FIR_TEST_DATA_COUNT] = {
		1181,
		1421,
		1518,
		1394,
		1223,
		1305,
		1300,
		1100,
		1157,
		1054,
		1436,
		1137,
		1134,
		1305,
		1066,
		1059,
		1219,
		1372,
		1037,
		1266,
		1102,
		1127,
		 977,
		1387,
		1496,
		1029,
		1261,
		1337,
		1326,
		1346,
		1314,
		1170,
		1224,
		1099,
		1544,
		1144,
		1071,
		1276,
		1402,
		1204,
		1270,
		1238,
		1066,
		1325,
		1076,
		1136,
		1262,
		1215,
		1275,
		1287,
		1088,
		1006,
		1422,
		1308,
		1201,
		1443,
		 966,
		1254,
		1244,
		1507,
		1283,
		1364,
		1494,
		1069,
		 945,
		1236,
		1183,
		1223,
		1177,
		 986,
		1258,
		1176,
		1337,
		1376,
		1308,
		1045,
		1098,
		1350,
		1017,
		1176,
		1120,
		1123,
		1116,
		1161,
		1313,
		1138,
		 897,
		 989,
		1422,
		1332,
		1199,
		1305,
		1356,
		1202,
		1309,
		1268,
		1261,
		1274,
		1051,
		1310,
		1023,
		1109,
		1164,
		1281,
		1356,
		1231,
		1073,
		1207,
		1373,
		1156,
		1243,
		1453,
		1208,
		1451,
		1313,
		1249,
		1183,
		1397,
		1269,
		1043,
		1232,
		1230,
		1252,
		1386,
		1480,
		1303,
		1419,
		1084,
		1343,
		1318,
		1361,
		1358,
		1025,
		1277,
		1350,
		1049,
		1195,
		1133,
		1106,
		1371,
		 953,
		1129,
		1300,
		1395,
		1520,
		1220,
		1335,
		1301,
		1113,
		1400,
		1242,
		1395,
		1111,
		1287,
		1240,
		1528,
		1422,
		1208,
		1009,
		1315,
		1261,
		1456,
		 941,
		1327,
		1149,
		1345,
		1064,
		1129,
		1173,
		1259,
		1535,
		1285,
		1313,
		1357,
		1074,
		1200,
		1181,
		1104,
		1409,
		1295,
		1450,
		1388,
		1235,
		1397,
		1305,
		1724,
		1310,
		1307,
		1153,
		1111,
		1378,
		1124,
		1205,
		 999,
		 970,
		1349,
		1307,
		1147,
		1381,
		1180};

static double firOutputTestData[FIR_TEST_DATA_COUNT] ={0.00139657828673217,0.00925492568771311,0.0329393444123916,0.084056694749758,0.171252386794458,0.291188684641645,0.417281305129742,0.489202770061016,0.409082783588186,0.0514374945526552,-0.707489966128739,-1.94020505687107,-3.6043930743777,-5.47905479403751,-7.12282261667795,-7.88132898226722,-6.96570889404167,-3.61322237594,2.67841330066818,11.8787951339822,23.1757969874974,34.8273185166933,44.1934200194834,48.0102902842895,42.9254590601303,26.2548059352261,-3.14060098656842,-44.0145030844832,-92.1222786892737,-140.018283900434,-177.398156645563,-192.034134306156,-171.238206680986,-103.671840573502,18.7735472990707,199.349033394787,435.385084834883,718.029752057646,1032.895132502,1361.55863917873,1683.71056344914,1979.61715363082,2232.50591119471,2430.49332426389,2567.75992368455,2644.81645102694,2667.87058268697,2647.45902992881,2596.62555138605,2528.98131750939,2456.97000415147,2390.58661843569,2336.68652801714,2298.8935638605,2278.00418089175,2272.71163928487,2280.44605463014,2298.14615707228,2322.83533742817,2351.9467711146,2383.41271491265,2415.58655685083,2447.09030485403,2476.67435656251,2503.14880597412,2525.40836941631,2542.53346395909,2553.9230660307,2559.40723020218,2559.29515802301,2554.33639205982,2545.59921111936,2534.29330353374,2521.57842496101,2508.40222675504,2495.40005121017,2482.87309984162,2470.84181940317,2459.15373031416,2447.61651017614,2436.12590672824,2424.76453169897,2413.85765341385,2403.98088796852,2395.922725014,2390.61012568276,2389.00516197087,2391.98111349407,2400.185690381,2413.90020199985,2432.90885506672,2456.40050685424,2482.92872603904,2510.45369679601,2536.48421769522,2558.32291625073,2573.3947283243,2579.61772162417,2575.75779221176,2561.69920038948,2538.5688241675,2508.67269418958,2475.23543666059,2441.96983683215,2412.53946734359,2390.00315746572,2376.33672919167,2372.11811916387,2376.43609313271,2387.04080423607,2400.71123016769,2413.77837029743,2422.71538495679,2424.69786460784,2418.0464224351,2402.48700674584,2379.19687685194,2350.63881398231,2320.21706090408,2291.811969378,2269.26116749224,2255.85656555305,2253.91910299794,2264.49938795704,2287.23553621928,2320.3802148577,2360.99047608136,2405.25735617673,2448.93766983558,2487.8381550985,2518.29563323294,2537.5959816441,2544.28038232386,2538.30200427784,2521.01530777227,2494.99877464322,2463.73636966025,2431.20147478758,2401.39612830395,2377.90325436201,2363.50408705408,2359.90039946138,2367.56745546053,2385.74682345264,2412.57220388326,2445.30824901833,2480.67516207987,2515.2258570231,2545.73641233897,2569.57072402355,2584.9809448247,2591.30840547017,2589.05770376758,2579.82838283063,2566.10464626826,2550.92291359666,2537.45416778979,2528.55368049221,2526.34050533997,2531.86849929079,2544.93867503902,2564.08510631111,2586.74144797804,2609.56916205684,2628.90455999175,2641.26374555423,2643.83569262874,2634.89542364677,2614.07996258898,2582.48952978981,2542.59854195032,2497.9847737021,2452.91006125478,2411.80762122157,2378.741957789,2356.912804024,2348.27169622143,2353.30432652716,2371.01039143095,2399.08391644005,2434.26652509192,2472.81907028843,2511.0362868619,2545.72219190956,2574.55113164883,2596.25929366716,2610.64279087026,2618.37478243645,2620.68963236353,2619.00741172218,2614.58072600148,2608.23807867128,2600.27563128221,2590.51402827175,2578.49759244399,2563.78100751011,2546.22680137985,2526.23232849962,2504.8235536719,2483.58312261274};

static double iirCoefficientsB[FILTER_IIRFILTERS][IIR_COEFFICIENT_COUNT] = {

		{5.53774282957553e-08,8.63013648449047e-09,-1.14197658483915e-06,-1.13939341744732e-07,3.72476608905631e-06,2.22127075317958e-07,-3.57641058827856e-06,-1.02923825030645e-07,1.01083279980851e-06,7.04199011677163e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,7.23128326703533e-09,-1.51430232867565e-06,-1.24345424035908e-07,5.51142373959059e-06,2.59290356889146e-07,-5.29183762641806e-06,-1.12322786872885e-07,1.34037456002849e-06,5.90055851255122e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,5.29977330815175e-09,-1.92045891839663e-06,-1.1421696013835e-07,7.7466127220412e-06,2.53891852708587e-07,-7.43789504033612e-06,-1.0317295922446e-07,1.69985966068909e-06,4.32449142886738e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,3.47929963325308e-09,-2.18864851188016e-06,-8.49905145770754e-08,9.38622737609855e-06,1.96376107219376e-07,-9.01211814761873e-06,-7.67722837480998e-08,1.93723156465299e-06,2.83902736355182e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,1.62145342178359e-09,-2.34766894095468e-06,-4.23732551896796e-08,1.04199111758415e-05,1.00075261016102e-07,-1.00045731129889e-05,-3.82758813293574e-08,2.0779789423878e-06,1.32306817992114e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,-9.18649103685022e-10,-2.37762567949022e-06,2.43020850428004e-08,1.06197636540926e-05,-5.76286213568604e-08,-1.01964541568667e-05,2.19521366528753e-08,2.104493349492e-06,-7.49596245732232e-10,-4.51866900890529e-08},
		{5.53774282957553e-08,-2.86852732558218e-09,-2.25370839501238e-06,7.20723495581997e-08,9.8036043695089e-06,-1.68041714541857e-07,-9.41284818525294e-06,6.51032115926041e-08,1.99481541095428e-06,-2.34065140368773e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,-5.60919071071116e-09,-1.86381711049113e-06,1.17477989027334e-07,7.41697861782909e-06,-2.58933882394913e-07,-7.12140662896146e-06,1.06118746439558e-07,1.64972656785784e-06,-4.57696881374957e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,-7.01212339673984e-09,-1.56668453298947e-06,1.2451606702181e-07,5.7829236989692e-06,-2.61913132733017e-07,-5.55251207546304e-06,1.1247681842818e-07,1.38673752068737e-06,-5.72172916919289e-09,-4.51866900890529e-08},
		{5.53774282957553e-08,-8.39873793657332e-09,-1.20810002397999e-06,1.16840164128305e-07,4.02374244204715e-06,-2.30719169920443e-07,-3.86346853624904e-06,1.05543978096609e-07,1.06935798880496e-06,-6.85317429787978e-09,-4.51866900890529e-08}

};


static double iirCoefficientsA[FILTER_IIRFILTERS][IIR_COEFFICIENT_COUNT-1] = {
		{-7.35324580430287,26.2311138204615,-58.8948353608113,91.6454942368739,-102.950813933996,84.4877620596799,-50.0539658433557,20.5517728765454,-5.31097294132233,0.665817942343443},
		{-6.16136296785258,19.7851949195999,-41.3987111276161,61.9584760111217,-68.6830735503277,57.1197667824781,-35.1846134167316,15.5016326769979,-4.45012078676633,0.665817942343443},
		{-4.51563378075868,12.7535768224597,-23.9850650844082,34.3203944953708,-37.1408210080598,31.6404936655824,-20.3851807573777,9.99261871539083,-3.26147247906451,0.665817942343443},
		{-2.96451226189863,8.11052326447354,-12.9909642998322,18.7855295880269,-18.9847214598418,17.3189483646002,-11.0413671813548,6.3549571527076,-2.14115573260842,0.665817942343443},
		{-1.3815477416875,5.35746950345114,-5.29281863547169,10.594085918242,-7.41220025848192,9.76723361644873,-4.49857418036271,4.19804086445021,-0.997839983664591,0.665817942343443},
		{0.782728370453726,4.83884109719401,2.91743605078471,9.13593943734179,4.04893261920451,8.42295986738527,2.47965144847269,3.79171459765273,0.565335269147736,0.665817942343443},
		{2.44410810411542,6.98416888981086,10.1594148986363,15.3424058047474,14.6042629915346,14.1447277524264,8.63480585414376,5.47249995864334,1.76528737813005,0.665817942343443},
		{4.77927065617046,13.7341926036701,26.3235129451824,37.8775637359811,41.2001422477223,34.9198244591175,22.3725868010368,10.7608950857838,3.45188748067202,0.665817942343443},
		{5.9746293745174,18.8783238626162,39.0594653446196,58.1157954303204,64.2830006158081,53.5772486967442,33.1965586586481,14.7911325836648,4.31525013401884,0.665817942343443},
		{7.15608433360639,25.0863465482443,55.6758904825641,86.0692694091044,96.4769750294261,79.3471383460919,47.3183040890217,19.6548898549831,5.16857062487486,0.665817942343443}

};

static double iirTestInput[TEST_DATA_COUNT] = {
		0,0.00139657828673217,0.00925492568771311,0.0329393444123916,0.084056694749758,0.171252386794458,0.291188684641645,0.417281305129742,0.489202770061016,0.409082783588186,0.0514374945526552,-0.707489966128739,-1.94020505687107,-3.6043930743777,-5.47905479403751,-7.12282261667795,-7.88132898226722,-6.96570889404167,-3.61322237594,2.67841330066818,11.8787951339822,23.1757969874974,34.8273185166933,44.1934200194834,48.0102902842895,42.9254590601303,26.2548059352261,-3.14060098656842,-44.0145030844832,-92.1222786892737,-140.018283900434,-177.398156645563,-192.034134306156,-171.238206680986,-103.671840573502,18.7735472990707,199.349033394787,435.385084834883,718.029752057646,1032.895132502,1361.55863917873,1683.71056344914,1979.61715363082,2232.50591119471
};

static double iirTestOutput[FILTER_IIRFILTERS][TEST_DATA_COUNT] = {
		{0,7.73389139329197e-11,1.09325868926623e-09,6.31942176854156e-09,1.65568120786521e-08,-9.97923043836337e-09,-2.75090181863618e-07,-1.31882775715397e-06,-4.05891737307402e-06,-9.25860624465743e-06,-1.59760362038619e-05,-1.91003408659166e-05,-7.30075393585411e-06,3.5885924643262e-05,0.00012467347108382,0.000256062733410411,0.00039073980166063,0.000439671158060536,0.000270995784066867,-0.000249481636616139,-0.00118158620965061,-0.00241484669753224,-0.00359274832779,-0.00411076874787713,-0.00323565406340961,-0.00035969010171859,0.00465386983413421,0.0111423908847474,0.0174842201351763,0.0212539842643044,0.0197676430358252,0.0109619582271446,-0.00560126398353127,-0.0279384189036476,-0.0514186782859739,-0.0693750489390202,-0.0745902116145614,-0.0613931577565515,-0.027819461173412,0.0228670980397939,0.0819360812569412,0.13658519116016,0.172845041478841,0.179351223732803},
		{0,7.73389139329197e-11,9.99126157130057e-10,4.40199283851426e-09,1.26072492518977e-09,-7.59982129062288e-08,-4.30201406725091e-07,-1.37134485414027e-06,-2.92353508397895e-06,-3.96232544533572e-06,-1.41367820715485e-06,9.17967528219798e-06,3.04574262508909e-05,5.78110699508401e-05,7.49694173122994e-05,5.57250679498172e-05,-2.46990338218324e-05,-0.000170878320736964,-0.000350246828051376,-0.000490332130866325,-0.000497872025192059,-0.000296211932722204,0.000134209957977616,0.000731557378312412,0.00135683991538972,0.00182524437726648,0.00195142894386074,0.0015935953224006,0.000688512576819219,-0.000721473415257802,-0.00246726017297969,-0.0042442823449112,-0.0056338463499713,-0.00617229796735138,-0.00546816162092398,-0.00333810821146169,9.04127024098887e-05,0.004360742793225,0.00877335284880103,0.0125523474334497,0.0150327432291401,0.0158046446410876,0.0147772146679503,0.0121646305017987},
		{0,7.73389139329197e-11,8.69149744303324e-10,2.12948813114596e-09,-1.27176034672124e-08,-1.09962297051287e-07,-3.86343626892054e-07,-7.57159437603124e-07,-5.98541222355575e-07,1.2333984333186e-06,5.35954524736293e-06,1.01534359152097e-05,1.12135832778755e-05,3.86134690003689e-06,-1.23676684833299e-05,-3.15325976843835e-05,-4.4811913663065e-05,-4.72601690678686e-05,-4.03661446729573e-05,-2.62517324681864e-05,4.39953387048026e-07,5.11535545603029e-05,0.000128904876063661,0.000213261338397084,0.000263275784892074,0.000241605636992681,0.000139860549655445,-1.96044861410685e-05,-0.000207034751577154,-0.000406771502571293,-0.000609570232038973,-0.000781739869977337,-0.000849476509009091,-0.000728434616105918,-0.000381839040323171,0.000146098114365257,0.000756714528730101,0.00135916368218778,0.00190608609179042,0.00236921750379958,0.00269037542616775,0.00277611354837093,0.00255911343619606,0.0020706296373334},
		{0,7.73389139329197e-11,7.46645256650776e-10,3.85857811804543e-10,-1.95121222460354e-08,-1.02721296477528e-07,-2.36716106690691e-07,-1.75945450303694e-07,5.14252295330214e-07,1.85204593750728e-06,2.79095159558756e-06,1.81923830955266e-06,-1.15242080483788e-06,-4.07754366605163e-06,-5.25434008533465e-06,-6.29750254691009e-06,-1.02851748283867e-05,-1.56195539697248e-05,-1.43565638875775e-05,-5.04083427698198e-07,2.07106980870861e-05,3.69217218204161e-05,4.36559234051219e-05,4.93623382042083e-05,5.9534007772724e-05,6.01775189568822e-05,2.83404780545662e-05,-3.78055910644383e-05,-0.000109668746108645,-0.000157805988766545,-0.000183301722444205,-0.000204798893135263,-0.000215212994229449,-0.000171681392176495,-4.30289296728784e-05,0.000144204559607393,0.000328057716297125,0.00047811273469926,0.000616410640138143,0.000760492907211334,0.000868550780637883,0.00087168867649376,0.000758418315470734,0.000595988789402752},
		{0,7.73389139329197e-11,6.21625872184276e-10,-9.95135906076657e-10,-2.13742545286166e-08,-7.52781295610466e-08,-8.65226073225342e-08,1.33183413078342e-07,5.85859790791365e-07,7.86503523965161e-07,2.78855108707184e-07,-4.27163652833312e-07,-3.98939713739251e-07,-2.34988181048757e-07,-1.84961956857541e-06,-4.93502918149706e-06,-5.79287450358876e-06,-2.48822554112302e-06,1.19410744841793e-06,1.64862188151013e-06,3.09573037375342e-06,1.1747962288001e-05,2.2891135715224e-05,2.42117379921459e-05,1.44893128276541e-05,6.25530991509156e-06,3.32229957589913e-06,-9.3589963925289e-06,-4.02217498148941e-05,-6.97902982430231e-05,-7.50569622820026e-05,-6.39115069186898e-05,-5.83506360279146e-05,-4.98253468359154e-05,-6.1912672844435e-06,7.28805705382308e-05,0.000145710180602066,0.000189152122381639,0.000230551532412557,0.0002912850681188,0.000335229951263381,0.000317625582128336,0.00025927801177994,0.000216901756133767},
		{0,7.73389139329197e-11,4.50695656187169e-10,-2.23194923552307e-09,-1.80056913365901e-08,-3.09827139195693e-08,2.8576368283798e-08,1.50741745644705e-07,1.38630460288405e-07,-2.97104088950687e-08,2.75601168594468e-08,2.78239155640895e-07,-7.28258379221694e-08,-9.58840470649258e-07,-1.01228096613627e-06,-3.42934339013232e-07,-8.39103140713917e-07,-1.83932029319702e-06,-3.78624594999204e-07,2.47933010480724e-06,2.80901089590941e-06,2.25211500067446e-06,5.18882543140872e-06,8.09458221303359e-06,4.8102483264324e-06,-4.68089130066944e-07,-1.26758239240221e-06,-3.5056332176935e-06,-1.35182096276475e-05,-2.18552182144442e-05,-1.97581561098877e-05,-1.65931711351579e-05,-1.87560778531615e-05,-1.24452621592995e-05,9.14490446129123e-06,2.88393088534678e-05,3.87968606050773e-05,5.6038983791501e-05,8.2813865292871e-05,9.45872671397563e-05,8.74576401155077e-05,8.63345130514607e-05,9.08578472601654e-05,7.37762390883448e-05},
		{0,7.73389139329197e-11,3.19483194369137e-10,-2.67093153417368e-09,-1.26858901555722e-08,-5.40715741239521e-09,4.19857817682479e-08,4.98479059483967e-08,-1.82025596001145e-08,3.2524361457752e-08,1.61172656014059e-07,-3.90557756585583e-08,-3.11221217401608e-07,-8.75077250046527e-08,-8.50564503161866e-08,-7.54611596788518e-07,-6.297529160913e-07,2.86692265521832e-07,1.53214428492388e-08,-2.37332423020637e-07,1.55699041768147e-06,2.48115333970045e-06,1.22167590732351e-06,1.86368872797586e-06,3.24261672431935e-06,4.70086030691333e-07,-2.47402726089973e-06,-1.91215913043896e-06,-4.32723955121238e-06,-9.46594204271384e-06,-8.67912617396119e-06,-5.97613970038991e-06,-7.62707010381616e-06,-4.31019246794787e-06,5.93927074770979e-06,1.10975023910451e-05,1.51507392161313e-05,2.72869250905054e-05,3.50887220470273e-05,3.35887198062442e-05,3.75161892860094e-05,4.15973682326874e-05,3.21281801324335e-05,2.40182644949045e-05},
		{0,7.73389139329197e-11,1.35056707761462e-10,-2.53844306687798e-09,-4.37416139985482e-09,8.34894494462932e-09,9.34245290145406e-09,-1.21530995800256e-08,2.51225323090046e-08,4.31899472078991e-08,-4.82295415443515e-08,3.25795264246557e-09,5.34321285482339e-08,-1.75846557662192e-07,-1.01893346443181e-07,6.54829574730122e-08,-3.05614080405973e-07,-1.18786890665393e-07,3.49780959118811e-07,-1.3897374388657e-07,1.87003278285431e-07,1.01095100717317e-06,1.91750432336284e-07,3.3876296376271e-07,1.25501970913875e-06,-3.19874446246974e-07,-7.58403710600359e-07,1.74506745646532e-07,-2.04624348432478e-06,-2.73162365943721e-06,-9.64224327703975e-07,-2.75936762300825e-06,-2.63156957171557e-06,1.04846592083617e-06,5.09306351588457e-07,1.64683188335756e-06,6.83636790060833e-06,6.59033611380934e-06,7.09800217716179e-06,1.17714852999908e-05,9.86056675543478e-06,7.96357924088393e-06,1.08330487524149e-05,6.88953177039567e-06},
		{0,7.73389139329197e-11,4.06496573972082e-11,-2.13169380013381e-09,-9.539172847458e-10,6.37697383544859e-09,-3.67250168071516e-09,-5.15580129196084e-10,2.65767706823334e-08,-1.30338416953497e-08,-4.89100358182976e-09,4.60023886007476e-08,-7.04648510554354e-08,-2.89258507587209e-08,4.24156014718438e-08,-1.8144977964186e-07,-5.42550224886501e-09,7.85299017679202e-08,-2.17117043413757e-07,2.28407684607458e-07,2.30174627222802e-07,-9.28652075704641e-08,6.05433811797238e-07,2.36908441852844e-07,-1.14872938067211e-07,6.00879268114421e-07,-4.26963276954559e-07,-6.35611841773531e-07,-5.57917261029571e-08,-1.55033564619196e-06,-1.0232533960893e-06,-4.29168983373578e-07,-1.66732242616407e-06,1.89227655045309e-07,7.9625326629182e-07,3.11517329437932e-07,3.18076349430468e-06,3.08601612324616e-06,3.06724130859035e-06,5.6500505498261e-06,3.94098712520137e-06,3.94461163137627e-06,5.1622044381363e-06,1.96832660154418e-06},
		{0,7.73389139329197e-11,-5.26593017577947e-11,-1.50415616611669e-09,1.13948012210131e-09,1.53925890109934e-09,-4.88036264468655e-09,9.87579149360102e-09,4.44189018437323e-10,-7.95960680003235e-09,2.68466773360215e-08,-2.50739367672287e-08,-3.46806424455496e-09,2.37576441623001e-08,-8.39162917197864e-08,3.46272744865529e-08,-2.85220712032059e-08,-9.19924157474412e-08,1.35534118013067e-07,-9.80430902858177e-08,8.46789844592894e-08,2.15143282428539e-07,-1.26466375926753e-07,3.605868244469e-07,1.32789542690465e-08,-1.24324156379081e-07,3.33981846334167e-07,-5.72002117121827e-07,-7.76500361062812e-08,-2.07855323426207e-07,-9.76660728136182e-07,2.03056490951278e-07,-7.40455732147911e-07,-2.74100962588161e-07,7.94577118624516e-07,-4.35407861254175e-07,1.52931385465961e-06,1.19459604059351e-06,7.60980097114076e-07,2.89504490244357e-06,7.29481312754259e-07,1.93974670140287e-06,2.21134430411745e-06,-3.04258909979518e-07}
};


static double powerTestForce[FILTER_IIRFILTERS][TEST_DATA_COUNT] = {
		{3.066659564651520E-15,	1.759845574504820E-13,	3.904843749066620E-13,	1.935382498916190E-11,	4.616013492613470E-10,	2.515268922508110E-09,	4.627260641433020E-09,	5.332820511935940E-09,	4.233512084836640E-08,	1.883215995168090E-07,	3.695750641431060E-07,	3.890035101758090E-07,	6.502388110697400E-07,	2.276302803821110E-06,	4.987613153817030E-06,	6.235682770903230E-06,	6.429938971753260E-06,	1.267163374790910E-05,	2.826671093146790E-05,	4.138110055340510E-05,	4.243305751147660E-05,	5.198292516486420E-05,	9.82558811E-05,	1.59582387E-04,	1.82753755E-04,	1.85446418E-04,2.63056867E-04,4.30030677E-04,5.52520113E-04,5.61582821E-04,6.28094020E-04,9.20169195E-04,1.27072349E-03,1.39241639E-03,1.40403283E-03,1.73247362E-03,2.38908874E-03,2.83857528E-03,2.87108331E-03,3.07493836E-03,3.92643610E-03,4.89287422E-03,5.21332108E-03,5.23926808E-03},
		{3.066659564651520E-15,
				1.244713225256350E-13,
				3.389711399818170E-13,
				5.778266919774760E-11,
				5.000301934699280E-10,
				7.662182684385360E-10,
				2.878209987363060E-09,
				2.692502699159150E-08,
				6.392732732801380E-08,
				6.393309079487140E-08,
				2.451865554210700E-07,
				8.174478661639220E-07,
				1.078683167059020E-06,
				1.306474340801730E-06,
				4.017784690816370E-06,
				7.586226275907800E-06,
				7.780482476760430E-06,
				1.239178007929510E-05,
				2.798685726340620E-05,
				3.673506749498720E-05,
				3.778702445323780E-05,
				6.846191417992360E-05,
				1.14734870E-04,
				1.22071974E-04,
				1.45243342E-04,
				2.52582190E-04,
				3.30192639E-04,
				3.30251980E-04,
				4.52741416E-04,
				6.85599975E-04,
				7.52111173E-04,
				7.96235101E-04,
				1.14678940E-03,
				1.47546054E-03,
				1.48707698E-03,
				1.74235802E-03,
				2.39897314E-03,
				2.68377930E-03,
				2.71628733E-03,
				3.41125285E-03,
				4.26275060E-03,
				4.36919862E-03,
				4.68964548E-03,
				5.91481325E-03},
				{3.066659564651520E-15,
						6.827741122908260E-14,
						2.239742199096440E-12,
						7.787717297535680E-11,
						1.502611695017650E-10,
						1.092840193103620E-09,
						9.087581664940090E-09,
						1.109836525716760E-08,
						4.332447486373680E-08,
						1.764352811310650E-07,
						1.871548832291030E-07,
						5.457209792692040E-07,
						1.456919607945110E-06,
						1.471227352035980E-06,
						3.609993372489870E-06,
						7.308656853816880E-06,
						7.309816517793640E-06,
						1.587050878143490E-05,
						2.644885312970100E-05,
						2.672730752334400E-05,
						5.262747217739360E-05,
						7.601087112308420E-05,
						7.83933469E-05,
						1.41941328E-04,
						1.84069045E-04,
						1.94576120E-04,
						3.26820178E-04,
						3.90585167E-04,
						4.23397104E-04,
						6.63945680E-04,
						7.46225542E-04,
						8.27848039E-04,
						1.21841079E-03,
						1.30895536E-03,
						1.48066660E-03,
						2.05521908E-03,
						2.13868123E-03,
						2.45523838E-03,
						3.22930581E-03,
						3.29046002E-03,
						3.81387249E-03,
						4.77624620E-03,
						4.80697801E-03,
						5.59570673E-03},
				{3.066659564651520E-15,
						3.117196321154500E-14,
						4.614191157633190E-12,
						5.462324721340300E-11,
						1.025463771243280E-10,
						2.422402025339670E-09,
						3.217545464701420E-09,
						1.941818645480290E-08,
						6.107919766395590E-08,
						7.502021626442790E-08,
						3.803197226651070E-07,
						4.368210667384000E-07,
						1.141082373402390E-06,
						2.354446332433730E-06,
						2.645604710866670E-06,
						7.462115913062900E-06,
						8.163409758138730E-06,
						1.526678549000590E-05,
						2.547550803330170E-05,
						2.756320054878140E-05,
						5.752344880705760E-05,
						6.136457133956520E-05,
						9.60576570E-05,
						1.40998573E-04,
						1.49359371E-04,
						2.59390882E-04,
						2.72418130E-04,
						3.81742747E-04,
						5.14036321E-04,
						5.37137747E-04,
						8.23716972E-04,
						8.55821130E-04,
						1.11160931E-03,
						1.40637639E-03,
						1.45552941E-03,
						2.03925124E-03,
						2.10199202E-03,
						2.58259283E-03,
						3.11605846E-03,
						3.20188819E-03,
						4.18686586E-03,
						4.28931737E-03,
						5.04975541E-03,
						5.86862067E-03},
				{3.066659564651520E-15,
						9.170646202526680E-15,
						6.442567854939590E-12,
						1.992627225165100E-11,
						3.719558528499000E-10,
						1.386506172060950E-09,
						4.872803616598150E-09,
						2.265881915098250E-08,
						3.299173581916770E-08,
						1.685839765010720E-07,
						1.733797492011220E-07,
						7.648593000966540E-07,
						7.933208227577180E-07,
						2.476935774789920E-06,
						3.059518371718350E-06,
						6.354311988719740E-06,
						9.703742685752700E-06,
						1.404651342692170E-05,
						2.551619521967930E-05,
						2.876661758315360E-05,
						5.687392455447780E-05,
						5.733111666161420E-05,
						1.10262137E-04,
						1.12516743E-04,
						1.91053528E-04,
						2.13731834E-04,
						3.04645533E-04,
						3.83965875E-04,
						4.61127804E-04,
						6.43007020E-04,
						6.81843000E-04,
						1.00019689E-03,
						1.00321310E-03,
						1.45213852E-03,
						1.47266833E-03,
						1.98941194E-03,
						2.13498496E-03,
						2.61118904E-03,
						3.01359946E-03,
						3.34034233E-03,
						4.09671989E-03,
						4.22855003E-03,
						5.33817447E-03,
						5.34414139E-03},
				{3.066659564651520E-15,
						5.025973062650330E-15,
						6.822041293385350E-12,
						1.131893070029570E-11,
						4.614827274840860E-10,
						8.273853165126870E-10,
						7.309320336339830E-09,
						1.455711849949100E-08,
						5.468488792664920E-08,
						1.203549931064660E-07,
						2.634197889973360E-07,
						6.256140233842590E-07,
						9.592976856171470E-07,
						2.373024119403830E-06,
						2.896567741300800E-06,
						7.160416175032630E-06,
						7.660092414127460E-06,
						1.815672104945280E-05,
						1.831382686377230E-05,
						4.016865973038250E-05,
						4.028678248348520E-05,
						7.967731437709460E-05,
						8.23433930E-05,
						1.44701598E-04,
						1.57329904E-04,
						2.44683109E-04,
						2.82309750E-04,
						3.90634221E-04,
						4.77771978E-04,
						5.95692859E-04,
						7.65832268E-04,
						8.75997498E-04,
						1.16768355E-03,
						1.25152076E-03,
						1.70087104E-03,
						1.74630563E-03,
						2.37713065E-03,
						2.38754595E-03,
						3.20145107E-03,
						3.20318866E-03,
						4.17269390E-03,
						4.21816218E-03,
						5.28562443E-03,
						5.44982504E-03},
				{3.066659564651520E-15,
						2.217058444724330E-14,
						5.324397738057140E-12,
						4.256785898688260E-11,
						1.753834680886780E-10,
						2.314670745657240E-09,
						2.319929332226600E-09,
						2.575846766801590E-08,
						3.986142430483890E-08,
						1.183561099884510E-07,
						3.360009669640040E-07,
						3.903360590002170E-07,
						1.463635195670770E-06,
						1.542200490692480E-06,
						3.978246683567220E-06,
						6.084667822929610E-06,
						8.362132781001160E-06,
						1.805542015119620E-05,
						1.814392258456350E-05,
						3.928865241231170E-05,
						4.472008605211620E-05,
						6.835259478388420E-05,
						1.03676523E-04,
						1.12113517E-04,
						1.98787031E-04,
						2.01479694E-04,
						3.15756756E-04,
						3.80543006E-04,
						4.52801317E-04,
						6.60890987E-04,
						6.65392693E-04,
						9.95772465E-04,
						1.05213977E-03,
						1.33878566E-03,
						1.65702157E-03,
						1.74908994E-03,
						2.39129231E-03,
						2.39963824E-03,
						3.11116421E-03,
						3.41633913E-03,
						3.81654477E-03,
						4.70009652E-03,
						4.73568743E-03,
						5.97847350E-03},
				{3.066659564651520E-15,
						7.611410478440410E-14,
						1.852134080445280E-12,
						7.825615636317970E-11,
						2.000972449251760E-10,
						8.012255780761510E-10,
						9.126760924533160E-09,
						1.500328917897450E-08,
						3.184876139956160E-08,
						1.777891377936990E-07,
						2.486450629823390E-07,
						4.085255933951330E-07,
						1.483861594978820E-06,
						1.904321186909360E-06,
						2.745274798430190E-06,
						7.557033858306470E-06,
						9.184196451870320E-06,
						1.223868559922250E-05,
						2.781406863489780E-05,
						3.254438153976620E-05,
						4.114627902962590E-05,
						8.129327409272240E-05,
						9.24889319E-05,
						1.12594475E-04,
						1.99928856E-04,
						2.22607162E-04,
						2.63335845E-04,
						4.29835434E-04,
						4.70472483E-04,
						5.44092309E-04,
						8.29541653E-04,
						8.95448394E-04,
						1.01664252E-03,
						1.46485865E-03,
						1.56320955E-03,
						1.74762929E-03,
						2.40093127E-03,
						2.53762303E-03,
						2.79990545E-03,
						3.69274253E-03,
						3.87130717E-03,
						4.22286893E-03,
						5.37574794E-03,
						5.59653469E-03},
				{3.066659564651520E-15,
						1.172239676452160E-13,
						4.694177626153720E-13,
						6.265295615674220E-11,
						4.686204722821560E-10,
						5.790142222291530E-10,
						3.859763599686070E-09,
						2.861116330261280E-08,
						5.291048407528780E-08,
						6.065964833031290E-08,
						3.106120162498430E-07,
						7.863099596278080E-07,
						8.346736453697320E-07,
						1.576484539032280E-06,
						4.625053201069030E-06,
						6.434399988470630E-06,
						6.845165436833190E-06,
						1.578290833607050E-05,
						2.824460187614980E-05,
						2.917112603972070E-05,
						4.134425481688240E-05,
						8.155472180212140E-05,
						1.01144757E-04,
						1.05185912E-04,
						1.77707437E-04,
						2.65060642E-04,
						2.70501752E-04,
						3.39401001E-04,
						5.41399950E-04,
						6.29344145E-04,
						6.47068112E-04,
						9.27123960E-04,
						1.23538920E-03,
						1.25226047E-03,
						1.46777130E-03,
						2.05091720E-03,
						2.28579912E-03,
						2.33346068E-03,
						3.01621153E-03,
						3.72055831E-03,
						3.75514261E-03,
						4.21099820E-03,
						5.37119368E-03,
						5.81093452E-03},
				{3.066659564651520E-15,
						1.668360300899970E-13,
						2.560203809905070E-13,
						2.574466181241440E-11,
						5.023600775474320E-10,
						2.283808310053630E-09,
						3.206163924385810E-09,
						6.776252740699570E-09,
						5.826654489533870E-08,
						1.933819621838530E-07,
						2.810366116087620E-07,
						2.966873071342050E-07,
						9.487565427418590E-07,
						2.797931667613430E-06,
						4.341613972023500E-06,
						4.360603786747200E-06,
						7.164196453797640E-06,
						1.768472834466140E-05,
						2.898033600508050E-05,
						3.075636572902300E-05,
						3.618779936909380E-05,
						7.025119602590420E-05,
						1.17797609E-04,
						1.34467776E-04,
						1.38403131E-04,
						2.10419689E-04,
						3.45468689E-04,
						4.21648233E-04,
						4.21680150E-04,
						5.25973583E-04,
						8.08051101E-04,
						1.03606333E-03,
						1.05792200E-03,
						1.15770565E-03,
						1.61130285E-03,
						2.11592122E-03,
						2.24801547E-03,
						2.29797549E-03,
						2.86970402E-03,
						3.74824025E-03,
						4.14844588E-03,
						4.14996997E-03,
						4.70899785E-03,
						5.95301364E-03}

};

static double powerTestPassive[FILTER_IIRFILTERS][TEST_DATA_COUNT]= {
		{5.537743136241490E-08,	4.712115799669890E-07,	9.343528715538950E-07,	-3.420320172861780E-06,	-2.444957887087140E-05,-6.976537661382250E-05,-1.157217293650090E-04,-8.916075882296960E-05,1.032353578811010E-04,4.854261116696080E-04,9.112001067815100E-04,1.050424242435800E-03,5.395542211219830E-04,-7.342530925855180E-04,-2.379773551913740E-03,-3.498407154357960E-03,-3.058715915788320E-03,-5.543300741627260E-04,3.404083599447990E-03,7.022982431066480E-03,8.036569528247730E-03,4.954781424123770E-03,-1.81091828E-03,-9.62698891E-03,-1.44788088E-02,-1.28583540E-02,-3.97375691E-03,9.03744108E-03,2.00604513E-02,2.29574578E-02,1.48594665E-02,-2.00517655E-03,-2.06697927E-02,-3.19301045E-02,-2.86318903E-02,-1.01921306E-02,1.57605461E-02,3.67545151E-02,4.20391182E-02,2.79326837E-02,-6.00107962E-04,-3.15727555E-02,-5.01197763E-02,-4.53204562E-02},
		{5.537743136241490E-08,
				4.038092689238320E-07,
				-5.933188798600020E-08,
				-7.638436753489640E-06,
				-2.866773393185660E-05,
				-4.498318121089060E-05,
				9.750756680812900E-07,
				1.560673719562470E-04,
				3.484401474031630E-04,
				3.460024287129570E-04,
				-7.955505171171250E-05,
				-8.356435946419880E-04,
				-1.347066448821660E-03,
				-8.698251568243160E-04,
				7.792640680431050E-04,
				2.669153116714050E-03,
				3.106523983318630E-03,
				9.635478137469170E-04,
				-2.974528697944760E-03,
				-5.939112914896600E-03,
				-4.921159638237510E-03,
				6.469549417834410E-04,
				7.46497580E-03,
				1.01347488E-02,
				5.33691837E-03,
				-4.93936047E-03,
				-1.37787682E-02,
				-1.36127196E-02,
				-2.42279492E-03,
				1.29472780E-02,
				2.09363704E-02,
				1.42713988E-02,
				-4.14526611E-03,
				-2.22964388E-02,
				-2.60217841E-02,
				-9.80060278E-03,
				1.62252337E-02,
				3.27296256E-02,
				2.67757458E-02,
				1.07600468E-03,
				-2.79478975E-02,
				-3.90103119E-02,
				-2.08952835E-02,
				1.50118341E-02},
				{5.537743136241490E-08,
						3.107414527185130E-07,
						-1.162845524818230E-06,
						-9.859750314330430E-06,
						-1.836763206515800E-05,
						1.233468799142850E-05,
						1.017550583555660E-04,
						1.465908360962140E-04,
						-3.289526985962400E-05,
						-3.976379218568840E-04,
						-5.012958243508410E-04,
						9.785590993951510E-05,
						1.052975789278740E-03,
						1.171693881113160E-03,
						-2.886337180995110E-04,
						-2.210264783940780E-03,
						-2.179908448374560E-03,
						7.545171549195990E-04,
						4.008971485598620E-03,
						3.470983815187650E-03,
						-1.592614911323140E-03,
						-6.430770098759350E-03,
						-4.90824397E-03,
						3.12462031E-03,
						9.59378685E-03,
						6.32070445E-03,
						-5.05730023E-03,
						-1.31110776E-02,
						-7.41386017E-03,
						8.30350493E-03,
						1.72160610E-02,
						8.18088673E-03,
						-1.12728336E-02,
						-2.10883427E-02,
						-7.90331242E-03,
						1.64693532E-02,
						2.51140251E-02,
						7.55506718E-03,
						-1.98094898E-02,
						-2.83425191E-02,
						-5.00205140E-03,
						2.64590586E-02,
						3.10710446E-02,
						3.74472702E-03},
						{5.537743136241490E-08,
								2.230238212494910E-07,
								-1.917770351980310E-06,
								-8.989433068660440E-06,
								-2.066781767992290E-06,
								4.610036998598240E-05,
								7.429713315374520E-05,
								-5.296919998430520E-05,
								-2.570540313907460E-04,
								-1.390096606909640E-04,
								4.138208424740970E-04,
								6.512721580544700E-04,
								-1.872828624025380E-04,
								-1.288301770756400E-03,
								-7.496330401335250E-04,
								1.449547456943260E-03,
								2.282865129479900E-03,
								-3.759486770496960E-04,
								-3.567952490078630E-03,
								-2.131188571233460E-03,
								3.370279535723930E-03,
								5.304038603281500E-03,
								-5.55193102E-04,
								-7.24874389E-03,
								-4.39381955E-03,
								6.19744175E-03,
								9.70976547E-03,
								-6.49778423E-04,
								-1.21287039E-02,
								-7.43150179E-03,
								9.76062703E-03,
								1.51722050E-02,
								-5.97490057E-04,
								-1.77272936E-02,
								-1.09619867E-02,
								1.37329179E-02,
								2.11328451E-02,
								-3.71904420E-04,
								-2.34159145E-02,
								-1.45991170E-02,
								1.76843850E-02,
								2.69236921E-02,
								5.63755381E-06,
								-2.85517569E-02},
						{5.537743136241490E-08,
								1.335054488239880E-07,
								-2.402902366221190E-06,
								-6.074911709765120E-06,
								1.268787818443570E-05,
								4.454054722299120E-05,
								-1.450185756068170E-05,
								-1.478517791854410E-04,
								-4.620827720672210E-05,
								3.221454990492430E-04,
								2.527631849080000E-04,
								-5.157272086575070E-04,
								-6.849956583145540E-04,
								6.142013834684080E-04,
								1.376371336365880E-03,
								-4.360730896570870E-04,
								-2.266163446022370E-03,
								-1.812385473206620E-04,
								3.212580229365830E-03,
								1.401468193459160E-03,
								-3.875307403662000E-03,
								-3.226797694862840E-03,
								4.10104691E-03,
								5.55190503E-03,
								-3.23391107E-03,
								-8.05194403E-03,
								1.55115889E-03,
								1.04457624E-02,
								1.65941763E-03,
								-1.17221253E-02,
								-5.63331648E-03,
								1.24886759E-02,
								1.04366163E-02,
								-1.03053347E-02,
								-1.52647137E-02,
								7.96349547E-03,
								1.96576893E-02,
								-1.83378040E-03,
								-2.19677441E-02,
								-3.96738121E-03,
								2.39645725E-02,
								1.18582943E-02,
								-2.04749372E-02,
								-1.91358656E-02},
						{5.537743136241490E-08,
								1.111329694152920E-08,
								-2.599821350449050E-06,
								-4.792366275818300E-07,
								2.073827285088510E-05,
								1.609608165908270E-06,
								-7.889474108305860E-05,
								6.240025996703230E-06,
								2.065920748639020E-04,
								-4.964417312386820E-05,
								-4.278058508342900E-04,
								1.742390294548340E-04,
								7.518641021251700E-04,
								-4.360581401249150E-04,
								-1.160511465929160E-03,
								9.081376585964740E-04,
								1.611251296984980E-03,
								-1.618601845194970E-03,
								-2.025307126274090E-03,
								2.671305879861900E-03,
								2.305879261396810E-03,
								-3.931036017351680E-03,
								-2.33494737E-03,
								5.62146589E-03,
								2.01810312E-03,
								-7.25346563E-03,
								-1.16913639E-03,
								9.30946570E-03,
								-4.64816839E-05,
								-1.08748367E-02,
								2.22113161E-03,
								1.26571200E-02,
								-4.24017807E-03,
								-1.36042931E-02,
								7.95910367E-03,
								1.42957068E-02,
								-1.02351328E-02,
								-1.40828178E-02,
								1.52496944E-02,
								1.31193479E-02,
								-1.70497635E-02,
								-1.12307829E-02,
								2.24632518E-02,
								8.74591166E-03},
						{5.537743136241490E-08,
								-8.283950120862810E-08,
								-2.385490760779050E-06,
								3.717283289443870E-06,
								1.524194432419360E-05,
								-3.100847916807140E-05,
								-3.330377402177060E-05,
								1.198161593348560E-04,
								1.050953848453360E-06,
								-2.790536849801480E-04,
								1.876096949751410E-04,
								4.205452741741190E-04,
								-6.144372756172790E-04,
								-3.351369951941240E-04,
								1.228004324957180E-03,
								-2.236767872841830E-04,
								-1.732632960790620E-03,
								1.388187327828070E-03,
								1.676076128313450E-03,
								-2.901207543402290E-03,
								-5.863772034820270E-04,
								4.293151749028620E-03,
								-1.63855051E-03,
								-4.57008779E-03,
								4.81800986E-03,
								3.09309552E-03,
								-7.48536509E-03,
								5.14134683E-04,
								9.02209564E-03,
								-5.26738651E-03,
								-7.59269705E-03,
								1.09095330E-02,
								3.12770414E-03,
								-1.35726371E-02,
								4.29812072E-03,
								1.36671796E-02,
								-1.11243985E-02,
								-8.86932345E-03,
								1.85083008E-02,
								6.32693255E-04,
								-1.92774162E-02,
								1.09305284E-02,
								1.60483793E-02,
								-1.79975966E-02},
						{5.537743136241490E-08,
								-2.148954074355980E-07,
								-1.547567698979690E-06,
								7.193446368392650E-06,
								-3.844673284899000E-06,
								-2.836211261141470E-05,
								6.288998338342310E-05,
								-1.377098279196140E-05,
								-1.435501221790500E-04,
								2.386004071946270E-04,
								-2.766244028981710E-05,
								-4.274240508132540E-04,
								6.104754940169060E-04,
								-3.860793815701680E-05,
								-9.552226732975880E-04,
								1.242320346570950E-03,
								-3.646708524962590E-05,
								-1.782749444928720E-03,
								2.176337429109350E-03,
								-9.435893830831240E-06,
								-2.938463470461530E-03,
								3.429247270708520E-03,
								5.43046253E-05,
								-4.42070601E-03,
								4.99180939E-03,
								1.64978840E-04,
								-6.19887354E-03,
								6.83036936E-03,
								3.29787332E-04,
								-8.21742959E-03,
								8.88964612E-03,
								5.51806831E-04,
								-1.04017263E-02,
								1.10964110E-02,
								8.29343437E-04,
								-1.26647109E-02,
								1.33639440E-02,
								1.15580874E-03,
								-1.49137362E-02,
								1.55971981E-02,
								1.52011763E-03,
								-1.70568656E-02,
								1.76985238E-02,
								1.90753683E-03},
						{5.537743136241490E-08,
								-2.824941907247270E-07,
								-8.759531298606530E-07,
								7.009762662578540E-06,
								-1.313852914311610E-05,
								-2.631981711155190E-06,
								5.464901487292580E-05,
								-1.026552901873000E-04,
								5.322665177708330E-05,
								1.412394390883960E-04,
								-3.584707233584380E-04,
								3.314636153039600E-04,
								1.111188289377550E-04,
								-7.494721679623960E-04,
								9.988496705073860E-04,
								-3.475091696174650E-04,
								-9.898176107359850E-04,
								2.008315176723510E-03,
								-1.518273270290910E-03,
								-5.672471878133610E-04,
								2.933000531325960E-03,
								-3.380134497247920E-03,
								1.02530824E-03,
								3.02002169E-03,
								-5.42745507E-03,
								3.93367026E-03,
								1.51913946E-03,
								-6.71795954E-03,
								7.62777358E-03,
								-1.86413779E-03,
								-6.14434232E-03,
								1.08528588E-02,
								-6.67641584E-03,
								-2.86034517E-03,
								1.20185814E-02,
								-1.17621977E-02,
								3.21539603E-03,
								9.93191093E-03,
								-1.55625014E-02,
								1.09986269E-02,
								4.44802291E-03,
								-1.64814808E-02,
								1.82845015E-02,
								-3.40595153E-03},
						{5.537743136241490E-08,
								-3.493066929341130E-07,
								-5.066927673723220E-08,
								4.997983800755120E-06,
								-1.683308851301450E-05,
								2.537542225085390E-05,
								-4.995744945769080E-06,
								-6.474331743236010E-05,
								1.622193271822410E-04,
								-2.052775385902170E-04,
								9.074027963442470E-05,
								2.157710155603650E-04,
								-5.911006064834560E-04,
								7.699402863429590E-04,
								-4.728153279753730E-04,
								-3.365364837771610E-04,
								1.340641342619280E-03,
								-1.895178659655160E-03,
								1.466490294299050E-03,
								1.242930644367770E-04,
								-2.202595167812440E-03,
								3.662422376778770E-03,
								-3.21948531E-03,
								8.32550051E-04,
								2.80358803E-03,
								-5.61458782E-03,
								6.06950306E-03,
								-2.71745578E-03,
								-2.61495047E-03,
								7.70172667E-03,
								-8.91565280E-03,
								6.13035569E-03,
								1.24887622E-03,
								-8.66237512E-03,
								1.29892601E-02,
								-9.42343091E-03,
								1.69727144E-03,
								8.68337747E-03,
								-1.47056995E-02,
								1.52412199E-02,
								-5.24225082E-03,
								-6.87547207E-03,
								1.73258021E-02,
								-1.72598180E-02}
};

//-------Private functions

void initXQueue() {
	  uint32_t j = 0;

	  queue_init(&xQueue, X_QUEUE_SIZE);
	  for(j = 0 ; j < X_QUEUE_SIZE ; j++) {
		  queue_overwritePush(&xQueue, 0);
	  }
}

void initYQueue() {
	uint32_t j = 0;

	queue_init(&yQueue, Y_QUEUE_SIZE);
	for(j = 0 ; j < Y_QUEUE_SIZE ; j++) {
		queue_overwritePush(&yQueue, 0);
	}

}

void initZQueues() {
	uint32_t i = 0;
	uint32_t j = 0;

	queue_init(&bSum, IIR_COEFFICIENT_COUNT);
	queue_init(&aSum, IIR_COEFFICIENT_COUNT-1);
	for(i = 0;i < FILTER_IIRFILTERS;i++) {
		queue_init(&zQueue[i], Z_QUEUE_SIZE);

		for(j = 0 ; j < Z_QUEUE_SIZE ; j++) {
			queue_overwritePush(&zQueue[i], 0);
			queue_overwritePush(&aSum, 0);
			queue_overwritePush(&bSum, 0);

		}
	}

}

void initPower() {
	for(int i = 0 ; i < FILTER_IIRFILTERS ; i++ ) {
		currentPowerValue[i] = 0;
		queue_init(&outputQueue[i], OUTPUT_QUEUE_SIZE);
		for(int j = 0 ; j < OUTPUT_QUEUE_SIZE ; j++ ) {
			queue_overwritePush(&(outputQueue[i]),0);
		}
//		filter_computePower(i, true, false);	// Does a force compute to init the functionallity
	}	
}
//-------Public functions

void filter_init() {

	initXQueue();
	initYQueue();
	initZQueues();
	initPower();

}

// Print out the contents of the xQueue for debugging purposes.
void filter_printXQueue() {
	uint32_t j = 0;
	printf("xQueue contents: \r\n");
	for(j = 0 ; j < X_QUEUE_SIZE ; j++) {
		printf(" %lf ", queue_readElementAt(&xQueue, j));
	}
	printf("\r\n");
}

// Print out the contents of yQueue for debugging purposes.
void filter_printYQueue() {
	uint32_t j = 0;
	printf("yQueue contents: \r\n");
	  for(j = 0 ; j < Y_QUEUE_SIZE ; j++) {
			printf(" %lf \r\n", queue_readElementAt(&yQueue, j));
	  }
	  printf("\r\n");
}

// Print out the contents of the the specified zQueue for debugging purposes.
void filter_printZQueue(uint16_t filterNumber) {
	uint32_t j = 0;
	printf("zQueue %d contents: \r\n",filterNumber);
	  for(j = 0 ; j < Z_QUEUE_SIZE ; j++) {
			printf(" %lf \r\n", queue_readElementAt(&(zQueue[filterNumber]), j));
	  }
	  printf("\r\n");
}

void filter_printOutputQueue(uint16_t filterNumber) {
	uint32_t j = 0;
	printf("outputQueue %d contents: \r\n",filterNumber);
	  for(j = 0 ; j < OUTPUT_QUEUE_SIZE ; j++) {
			printf(" %lf \r\n", queue_readElementAt(&(outputQueue[filterNumber]), j));
	  }
	  printf("\r\n");
}

// These print functions are for debugging purposes only
void filter_printBsum() {
	uint32_t j = 0;
	printf("bSum contents: \r\n");
	for(j = 0 ; j <Y_QUEUE_SIZE ; j++) {
			printf(" %lf ", queue_readElementAt(&bSum, j));
	}
	printf("\r\n");
}
void filter_printAsum() {
	uint32_t j = 0;
	printf("aSum contents: \r\n");
	for(j = 0 ; j < Z_QUEUE_SIZE ; j++) {
			printf(" %lf ", queue_readElementAt(&aSum, j));
	}
	printf("\r\n");
}


// Print for IIR and FIR debugging
void filter_printIIR(uint16_t filterNumber) {
	uint32_t j = 0;
	printf("yQueue	zQueue %d	aSum	bSum\r\n",filterNumber);
	for(j = 0 ; j < X_QUEUE_SIZE ; j++) {
		  printf(" %lf ", queue_readElementAt(&yQueue, j));
		  printf(" %lf ", queue_readElementAt(&zQueue[filterNumber], j));
		  printf(" %lf ", queue_readElementAt(&aSum, j));
		  printf(" %lf ", queue_readElementAt(&bSum, j));
		  printf("\r\n");
	}
}

void filter_printFIR() {
	uint32_t j = 0;
		printf("xQueue	yQueue	\r\n");
		  for(j = 0 ; j < X_QUEUE_SIZE ; j++) {
				printf(" %lf ", queue_readElementAt(&xQueue, j));
				printf(" %lf ", queue_readElementAt(&yQueue, j));
				printf("\r\n");
		  }
}


// Use this to copy an input into the input queue (x_queue).
void filter_addNewInput(double x) {
	queue_overwritePush(&xQueue, x);
}

// Invokes the FIR filter. Returns the output from the FIR filter. Also adds the output to the y_queue for use by the IIR filter.
double filter_firFilter() {
	uint32_t i;
	double firOutput = 0;
	for(i=0;i<FIR_COEFFICIENT_COUNT;i++) {
		firOutput += firCoefficients[i]*queue_readElementAt(&xQueue,X_QUEUE_SIZE-i-1);
	}
//	printf("fir output: %lf\r\n",firOutput);
	queue_overwritePush(&yQueue,firOutput);
	return firOutput;
}

// Use this to invoke a single iir filter. Uses the y_queue and z_queues as input. Returns the IIR-filter output.
double filter_iirFilter(uint16_t filterNumber) {

	double bsum = 0;
	double asum = 0;
	double returnVal = 0;


	bsum = 0;
	// Bsum calculation with B coefficients
	for(int j=0; j < Y_QUEUE_SIZE;j++) {
		bsum += iirCoefficientsB[filterNumber][Y_QUEUE_SIZE - j - 1]*queue_readElementAt(&yQueue, (j));  // IIR_COEFFICIENT_COUNT - i -1  AND i
	}

	queue_overwritePush(&bSum,bsum);	// This is used for our test function

	asum = 0;
	// Asum calculation with B coefficients
	for(int k=0; k < Z_QUEUE_SIZE;k++) {
		asum += iirCoefficientsA[filterNumber][k]*queue_readElementAt(&(zQueue[filterNumber]),(Z_QUEUE_SIZE-k-1));
	}

	queue_overwritePush(&aSum,asum);	// This is used for our test function

	returnVal = bsum - asum;	// We push this value onto our zQueue and our outputQueue
	queue_overwritePush(&(zQueue[filterNumber]),returnVal); // We assume that the number passed in is ok
	queue_overwritePush(&(outputQueue[filterNumber]),returnVal);

	return returnVal;
}

// Use this to compute the power for values contained in a queue.
// If force == true, then recompute everything from scratch.
double filter_computePower(uint16_t filterNumber, bool forceComputeFromScratch, bool debugPrint) {

	// Before calculating anything we grab the necessary values and initiallize returnPower
	double returnPower = 0;
	double newPower =  queue_readElementAt(&(outputQueue[filterNumber]),OUTPUT_QUEUE_SIZE - 1);
	double oldPower = queue_readElementAt(&(outputQueue[filterNumber]),0);

	// We reiterate over the entire outputQueue and find the sum of squares
	if(forceComputeFromScratch) {
		for(int i = 0 ; i < OUTPUT_QUEUE_SIZE ; i++) {
			returnPower += queue_readElementAt(&(outputQueue[filterNumber]),i) *  queue_readElementAt(&(outputQueue[filterNumber]),i);
		}
		currentPowerValue[filterNumber] = returnPower;
	}
	// Otherwise we just subtract the oldest value and add the newest value
	else {
		currentPowerValue[filterNumber] += (newPower * newPower);
		currentPowerValue[filterNumber] -= (oldPower * oldPower);
	}
	return returnPower;
}

double filter_getCurrentPowerValue(uint16_t filterNumber) {
	return currentPowerValue[filterNumber];
}

// Uses the last computed-power values, scales them to the provided lowerBound and upperBound args, returns the index of element containing the max value.
// The caller provides the normalizedArray that will contain the normalized values. indexOfMaxValue indicates the channel with max. power.
void filter_getNormalizedPowerValues(double normalizedArray[], uint16_t* indexOfMaxValue) {
	double maxPower = 0;
	double currentPower = 0;
	uint16_t indexMax;
	// We find the max power and its index with a simple search algorithm
	for(int i = 0 ; i < FILTER_IIRFILTERS ; i++) {
		currentPower = currentPowerValue[i];
		if(currentPower > maxPower) {
			indexMax = (uint16_t) i;
			maxPower = currentPower;
		}
	}
	*indexOfMaxValue = indexMax;
	// Then we normalize the power values
	for(int j = 0 ; j < FILTER_IIRFILTERS ; j++) {
		normalizedArray[j] = currentPowerValue[j]/currentPowerValue[indexMax];
	}
}


// Pushes a single 1.0 through the xQueue. Golden output data is just the coefficients in reverse order.
bool filter_runFirOneTest() {
    bool success = true;             // Be optimistic.
    filter_init();
    filter_addNewInput(1.0);    // Place a single 1.0 in the xQueue.
    for (int i=0; i<FIR_FILTER_TAP_COUNT; i++) {
        double firValue = filter_firFilter();        // Run the FIR filter.
        double firGoldenOutput =  firCoefficients[FIR_FILTER_TAP_COUNT-i-1]; // Golden output is the coefficient.
        if (firValue != firGoldenOutput) {
            success = false;
            printf("Output from FIR Filter(%le) does not match test-data(%le).\n\r", firValue, firGoldenOutput);
        }
        filter_addNewInput(0.0);
    }
    return success;
}

// Pushes a series of 1.0 though xQueue. Golden output data is the sum of the coefficients in reverse order.
bool filter_runFirOnesTest() {
    bool success = true;             // Be optimistic.
    filter_init();
    filter_addNewInput(1.0);    // Place a single 1.0 in the xQueue.
    double firGoldenOutput = 0.0;
    for (int i=0; i<FIR_FILTER_TAP_COUNT; i++) {
        double firValue = filter_firFilter();        // Run the FIR filter.
        firGoldenOutput +=  firCoefficients[FIR_FILTER_TAP_COUNT-i-1]; // Golden output is coefficient sum.
        if (firValue != firGoldenOutput) {
            success = false;
            printf("Output from FIR Filter(%le) does not match test-data(%le).\n\r", firValue, firGoldenOutput);
        }
        filter_addNewInput(1.0);  // Plae another 1 in the xQueue.
    }
    return success;
}




//bool filter_runTest() {
//	printf("\r\n-----Filter.c Test-----\r\n");
//
//	//Fir Filter Test
//	filter_init();
//	double IIR_error;
//	double FIR_out;
//	bool FIR_pass = true;
//	uint32_t tally_s = 0;
//	uint32_t tally_f = 0;
//	double FIR_error;
//
//	// Test 1 with force compute
//	for(int i=0 ; i < FIR_TEST_DATA_COUNT ; i++) {
//
//		filter_addNewInput(firInputTestData[i]);
//		FIR_out = filter_firFilter();
//		FIR_error = FIR_out - firOutputTestData[i];
//
//		if(!(FIR_error >= EPSILON_NEG && FIR_error < EPSILON_POS)) {
//			printf("FAIL! \r\n");
//			printf("FIR output is %lf and it should be %lf. At index %d\n\r",FIR_out, firOutputTestData[i], i);
//			FIR_pass = false;
//		}
//
//			if (FIR_pass) {
//				tally_s++;
//			}
//			else {
//				tally_f++;
//			}
//	}
//
//
//	printf("FIR filter successes: %ld fails: %ld\r\n\r\n",tally_s,tally_f);
//
//	// IIR filters test
//
//	filter_init();
//	IIR_error = 0;
//	double output;
//	double powerForce;
//	double powerPassive;
//	double powerForce_error;
//	double powerPassive_error;
//	tally_s= 0;
//	tally_f = 0;
//	uint32_t tally_pf_s = 0; // Tallies of force compute power values successes
//	uint32_t tally_pf_f = 0; // Tallies of force compute power values fails
//	uint32_t tally_pp_s = 0; // Tallies of non-force (passive) compute power values successes
//	uint32_t tally_pp_f = 0; // Tallies of non-force (passive) compute power values fails
//	uint32_t tally_cp_s = 0; // Tallies successes of getCurrentPowerValue function call
//	uint32_t tally_cp_f = 0; // Tallies fails of getCurrentPowerValue function call
//	double testNormalArray[FILTER_IIRFILTERS];
//	double maxNormal = 0;
//	double currentNormal = 0;
//	uint16_t testIndex = 0;
//
//	for(int j = 0 ; j < FILTER_IIRFILTERS; j++ ) {
//
//		for (int i = 0 ; i < TEST_DATA_COUNT ; i++) {
//
//			queue_overwritePush(&yQueue,iirTestInput[i]);
//			output = filter_iirFilter(j);
//			powerForce = filter_computePower(j, true, false);
//			powerPassive = filter_computePower(j, false, false);
//
//			// Check for zero
//			if(iirTestOutput[j][i] != 0) {
//				IIR_error = (output - iirTestOutput[j][i])/iirTestOutput[j][i];
//			}
//			else {
//				IIR_error = (output - iirTestOutput[j][i]);
//			}
//			if(powerTestForce[j][i] != 0) {
//				powerForce_error = (powerForce - powerTestForce[j][i])/powerTestForce[j][i];
//			}
//			else {
//				powerForce_error = (powerForce - powerTestForce[j][i]);
//			}
//			if(powerTestPassive[j][i]) {
//				powerPassive_error = (powerPassive - powerTestPassive[j][i])/powerTestPassive[j][i];
//			}
//			else {
//				powerPassive_error = (powerPassive - powerTestPassive[j][i]);
//			}
////			printf("%lf - %lf = %lf\r\n",powerForce,powerTestForce[j][i],powerForce_error);
////			printf("%lf - %lf = %lf\r\n",powerPassive,powerTestPassive[j][i],powerPassive_error);
////			printf("Force: %lf  Passive: %lf \r\n",powerForce_error , powerPassive_error);
//			if(!(IIR_error >= EPSILON_NEG && IIR_error <= EPSILON_POS)) {
//				tally_f++;
//				printf("IIR output is %lf and it should be %lf. At index %d\n\r",output, iirTestOutput[j][i], i);
//
//	//			printf("IIR Fail");
//			}
//			else {
//				tally_s++;
//	//			printf("IIR Success\r\n");
//			}
//
//			if(!(powerForce_error >= EPSILON_NEG && powerForce_error <= EPSILON_POS)) {
//				tally_pf_f++;
//			}
//			else {
//				tally_pf_s++;
//			}
//
//			if(!(powerPassive_error >= EPSILON_NEG && powerPassive_error <= EPSILON_POS)) {
//				tally_pp_f++;
//			}
//			else {
//				tally_pp_s++;
//			}
//
//			if(filter_getCurrentPowerValue(j) != powerForce) {
//				tally_cp_f++;
//			}
//			else {
//				tally_cp_s++;
//			}
//
//
//
//
//		}
//		printf("IIR filter %d successes: %ld fails: %ld\r\n",j,tally_s,tally_f);
//		printf("--Force Power filter %d successes: %ld fails: %ld\r\n",j,tally_pf_s,tally_pf_f);
//		printf("--Non-Force Power filter %d successes: %ld fails: %ld\r\n",j,tally_pp_s,tally_pp_f);
//		printf("--getCurrentPowerValue filter %d successes: %ld fails: %ld\r\n",j,tally_cp_s,tally_cp_f);
//		tally_s = 0;
//		tally_f = 0;
//		tally_pf_s = 0;
//		tally_pf_f = 0;
//		tally_pp_s = 0;
//		tally_pp_f = 0;
//		tally_cp_s = 0;
//		tally_cp_f = 0;
//
//	}
//
//	// Normalized Power Value test loop
//	filter_getNormalizedPowerValues(testNormalArray,&testIndex);
//	for (int k = 0 ; k < FILTER_IIRFILTERS ; k++) {
//		currentNormal = testNormalArray[k];
//		if (currentNormal >= maxNormal) {
//			maxNormal = currentNormal;
//			if(k == testIndex) {
//				printf("\r\n--getNormalizedPowerValue function passed\r\n\r\n");
//			}
//		}
//	}
//
//// Measurement of computational time
//	  intervalTimer_initAll();
//	  intervalTimer_resetAll();
//	  intervalTimer_testAll();
//	  static uint32_t timer = 1;	//Timer being used
//	  intervalTimer_reset(timer);
//	  intervalTimer_start(timer);
//	  int countIterations = 10;	//Number of times to run the filters
//
//	  for (int i = 0; i < countIterations ; i++) {
//		  filter_computePower(i, true, false);
//	  }
//	  intervalTimer_stop(timer);
//	  double runningSeconds;
//	  intervalTimer_getTotalDurationInSeconds(1, &runningSeconds);
//	  printf("\r\nTotal run time of forced power computation as measured by interval timer in seconds: %g.\n\r", runningSeconds);
//
//
//	  intervalTimer_resetAll();
//	  intervalTimer_start(timer);
//	  for (int i = 0; i < countIterations ; i++) {
//		  filter_computePower(i, false, false);
//	  }
//	  intervalTimer_getTotalDurationInSeconds(1, &runningSeconds);
//	  printf("Total run time of quick power computation as measured by interval timer in seconds: %g.\n\r\r\n", runningSeconds);
//
//
//// Real input test
//
//	uint32_t selectFilter = 2;  //Select individual filters to test
//	uint32_t testIterateMax = 100;  //Number of inputs to filter
//	printf("\r\nPushing %ld inputs through filter system.\r\n",testIterateMax);
//	printf("--Testing Filter %ld--\r\n",selectFilter);
//	filter_init();
//
//		for(uint32_t i = 0 ; i < testIterateMax ; i++) {
//			filter_addNewInput(firInputTestData[i]);
//			if((i+1)%10 ==0 &&  i !=0) {
//				filter_firFilter();
//
//				for(int j = 0 ; j < FILTER_IIRFILTERS ; j++) {
//					filter_iirFilter(j);
//				}
//			}
//		}
//		printf("\r\n**Compare these values with Excel spreadsheet**\r\n");
//		filter_printYQueue();
//		filter_printZQueue(selectFilter);
//
//
//		if(filter_runFirOnesTest()) {
//			printf("\r\nPassed runFirOnesTest\r\n");
//		}
//		if(filter_runFirOneTest()) {
//			printf("\r\nPassed runFirOneTest\r\n");
//
//		}
//
//
//		// compute power test
//
//		initPower();
//		double thisArray[10];
//		uint16_t indexMax;
//		for(int i = 0 ; i < 2501 ; i++) {
//			queue_overwritePush(&outputQueue[0],5);
//			queue_overwritePush(&outputQueue[1],6);
//			queue_overwritePush(&outputQueue[2],3);
//			queue_overwritePush(&outputQueue[3],2);
//			queue_overwritePush(&outputQueue[4],4);
//			queue_overwritePush(&outputQueue[5],7);
//			queue_overwritePush(&outputQueue[6],9);
//			queue_overwritePush(&outputQueue[7],12);
//			queue_overwritePush(&outputQueue[8],1);
//			queue_overwritePush(&outputQueue[9],8);
//			filter_computePower(0, false, false);
//			filter_computePower(1, false, false);
//			filter_computePower(2, false, false);
//			filter_computePower(3, false, false);
//			filter_computePower(4, false, false);
//			filter_computePower(5, false, false);
//			filter_computePower(6, false, false);
//			filter_computePower(7, false, false);
//			filter_computePower(8, false, false);
//			filter_computePower(9, false, false);
//			filter_getNormalizedPowerValues(thisArray, &indexMax);
////			printf("%lf %lf %lf %lf %lf %lf %lf %lf %lf %lf with normal max at %lf\r\n",filter_getCurrentPowerValue(0),filter_getCurrentPowerValue(1),filter_getCurrentPowerValue(2),filter_getCurrentPowerValue(3),filter_getCurrentPowerValue(4),filter_getCurrentPowerValue(5),filter_getCurrentPowerValue(6),filter_getCurrentPowerValue(7),filter_getCurrentPowerValue(8),filter_getCurrentPowerValue(9),thisArray[indexMax]);
//		}
//
//		for(int i = 0 ; i < 10 ; i++) {
//			printf("player %d: %lf\r\n",i,thisArray[i]);
//		}
//
//
//
//		return true;
//}

/*=============================================================================
 * ================= Test Routines Start Here =================================
 ==============================================================================*/

/* ===================== Test Variable Definitions ==================== */
static uint16_t firDecimationCount = 0;  // Used to keep track of samples relative to the decimation factor.

/* ================================== #defines ================================ */
#define FILTER_IIR_POWER_TEST_PERIOD_COUNT FILTER_FREQUENCY_COUNT
#define FILTER_FREQUENCY_COUNT FILTER_IIR_FILTER_COUNT
#define FILTER_SAMPLE_FREQUENCY_IN_KHZ 100

// NOTE: YOU MUST DEFINE THIS PROPERLY FOR THE TEST TO WORK PROPERLY.
// If you used a leading 1 in the A-coefficient array for your IIR, this should be defined to be a 1.
// If you did not use a leading 1 in the A-coefficient array for your IIR, this should be defined to be 0.
#define FILTER_TEST_USED_LEADING_1_IN_IIR_A_COEFFICIENT_ARRAY 0

/* ===================== Simple Accessor Functions ==================== */

// Returns the array of FIR coefficients.
double* filterTest_getFirCoefficientArray() {
  return firCoefficients;
}

// Returns the number of FIR coefficients.
uint32_t filterTest_getFirCoefficientCount() {
  return FIR_FILTER_TAP_COUNT;
}

// Returns the array of coefficients for a particular filter number.
double* filterTest_getIirACoefficientArray(uint16_t filterNumber) {
  return  iirCoefficientsA[filterNumber];
}

// Returns the number of A coefficients.
uint32_t filterTest_getIirACoefficientCount() {
  return IIR_COEFFICIENT_COUNT-1;
}

// Returns the array of coefficients for a particular filter number.
double* filterTest_getIirBCoefficientArray(uint16_t filterNumber) {
  return  iirCoefficientsB[filterNumber];
}

// Returns the number of B coefficients.
uint32_t filterTest_getIirBCoefficientCount() {
  return IIR_COEFFICIENT_COUNT;
}

// Returns the size of the yQueue.
uint32_t filterTest_getYQueueSize() {
  return Y_QUEUE_SIZE;
}

// Returns the decimation value.
uint16_t filterTest_getDecimationValue() {
  return FILTER_FIR_DECIMATION_FACTOR;
}

// Returns the starting index for the A-coefficient array for the IIR-filter.
// Some students use the leading 1, others did not.
uint16_t filterTest_getIirACoefficientArrayStartingIndex() {
  if (FILTER_TEST_USED_LEADING_1_IN_IIR_A_COEFFICIENT_ARRAY)
    return 1;
  else
    return 0;
}

/*==========================Helper Test Functions ============================ */

// Returns true if the values are within TEST_FILTER_FLOATING_POINT_EPSILON of each other.
//#define TEST_FILTER_FLOATING_POINT_EPSILON 1.0E-15L
static const double eps = 1.0E-15;
bool filterTest_floatingPointEqual(double a, double b) {
   return fabs(a-b) < eps;
}

// Fills the queue with the fillValue, overwriting all previous contents.
void filterTest_fillQueue(queue_t* q, double fillValue) {
  for (queue_size_t i=0; i<q->size; i++) {
    queue_overwritePush(q, fillValue);
  }
}

queue_data_t filterTest_filter_readMostRecentValueFromQueue(queue_t* q) {
  return queue_readElementAt(q, q->elementCount-1);
}

/* ============================ Major Test Functions ============================= */

// Invokes FIR-filter according to the decimation factor.
// Returns true if it invokes filter_firFilter().
bool filter_decimatingFirFilter() {
  if (firDecimationCount == filterTest_getDecimationValue()-1) {  // Time to run the FIR filter?
    filter_firFilter();      // Run the FIR filter.
    firDecimationCount = 0;  // Reset the decimation count.
    return true;             // Return true because you ran the FIR filter.
  }
  firDecimationCount++;  // Increment the decimation count each time you call this filter.
  return false;          // Didn't run the FIR filter.
}

// Pushes a single 1.0 through the xQueue. Golden output data are just the FIR coefficients in reverse order.
// If this test passes, you are multiplying the coefficient with the correct element of xQueue.
bool filterTest_runFirAlignmentTest(bool printMessageFlag) {
  bool success = true;	 					// Be optimistic.
  filterTest_fillQueue(&xQueue, 0.0);	// zero-out the xQueue.
  filter_addNewInput(1.0);				// Place a single 1.0 in the xQueue.
  for (uint32_t i=0; i<filterTest_getFirCoefficientCount(); i++) {	// Push the single 1.0 through the queue.
    filter_firFilter();								// Run the FIR filter.
    double firValue = filterTest_filter_readMostRecentValueFromQueue(&yQueue);
    double firGoldenOutput =  filterTest_getFirCoefficientArray()[filterTest_getFirCoefficientCount()-i-1];	// Golden output is simply the FIR coefficient.
    if (!filterTest_floatingPointEqual(firValue, firGoldenOutput)) {	// If the output from the FIR filter does not match the golden value, print an error.
      success = false;									// The test failed.
      printf("filter_runAlignmentTest: Output from FIR Filter(%le) does not match test-data(%le).\n\r", firValue, firGoldenOutput);
    }
    filter_addNewInput(0.0);	// Shift the 1.0 value over one position in the queue.
  }
  // Print informational messages.
  if (printMessageFlag) {
    printf("filter_runFirAlignmentTest ");
    if (success)
      printf("passed.\n\r");
    else
      printf("failed.\n\r");
  }
  return success;	// Return the success of failure of this test.
}

// Fills the xQueue with 1.0. Invokes filter_firFilter() and compares the output with the
// sum of the coefficients.
bool filterTest_runFirArithmeticTest(bool printMessageFlag) {
  bool success = true;							// Be optimistic.
  filterTest_fillQueue(&xQueue, 0.0);  // zero-out the xQueue.
  double firGoldenOutput = 0.0;			          // You will compute the golden output by accumulating the FIR coefficients.
  for (uint32_t i=0; i<filterTest_getFirCoefficientCount(); i++) {	// Loop enough times to go through the coefficients.
    firGoldenOutput += filterTest_getFirCoefficientArray()[i];
  }
  filterTest_fillQueue(&xQueue, 1.0);
  filter_firFilter();
  double firValue = filterTest_filter_readMostRecentValueFromQueue(&yQueue);
  if (!filterTest_floatingPointEqual(firValue, firGoldenOutput)) {
    success = false;									// Test failed.
    printf("filter_runArithmeticTest: Output from FIR Filter(%le) does not match test-data(%le).\n\r", firValue, firGoldenOutput);
  }
  // Print informational messages.
  if (printMessageFlag) {
    printf("filter_runFirArithmeticTest ");
    if (success)
      printf("passed.\n\r");
    else
      printf("failed.\n\r");
  }
  return success;	// Return the success or failure of the test.
}

// This test checks to see that the B coefficients are multiplied with the correct values of the yQueue.
// If it passes, the coefficients are properly aligned with the data in yQueue.
// This test only checks the coefficients for filterNumber (frequency).
bool filterTest_runIirBAlignmentTest(uint16_t filterNumber, bool printMessageFlag) {
  bool success = true;						// Be optimistic.
  filterTest_fillQueue(&yQueue, 0.0);	// zero-out the yQueue.
  filterTest_fillQueue(&(zQueue[filterNumber]), 0.0);	// zero out the zQueue for filterNumber.
  queue_overwritePush(&yQueue, 1.0);							// Place a single 1.0 in the yQueue.
  for (uint32_t i=0; i<filterTest_getIirBCoefficientCount(); i++) {
    filter_iirFilter(filterNumber);										// Run the IIR filter.
    double iirValue = filterTest_filter_readMostRecentValueFromQueue(&(zQueue[filterNumber]));										// Run the IIR filter.
    double iirGoldenOutput =  filterTest_getIirBCoefficientArray(filterNumber)[i];	// Golden output is simply the coefficient.
    if (!filterTest_floatingPointEqual(iirValue, iirGoldenOutput)) {	// Make sure they IIR output matches the golden output.
      success = false;									// Note test failure and print message.
      printf("filter_runIirBlignmentTest: Output from IIR Filter[%d](%le) does not match test-data(%le) at index(%ld).\n\r", filterNumber, iirValue, iirGoldenOutput, i);
    }
    filterTest_fillQueue(&(zQueue[filterNumber]), 0.0);	// zero out the zQueue for filterNumber so the A-summation is always 0.
    queue_overwritePush(&yQueue, 0.0);							// Shift the 1.0 over one position in the yQueue.
  }
  // Print informational messages.
  if (printMessageFlag) {
    printf("filter_runIirBAlignmentTest ");
    if (success)
      printf("passed.\n\r");
    else
      printf("failed.\n\r");
  }
  return success;	// Return the success or failure of the test.
}

// Checks to see that the A-coefficients are properly aligned with the zQueue.
// This test checks the A-coefficients for a specific filter-number (frequency).
// It is a little more work to create a sliding 1 in the zQueue because the IIR updates the zQueue.
// Thus as you move across coefficients, the zQueue is cleared out. 1.0 is added and shifted over the correct number of spaces.
bool filterTest_runIirAAlignmentTest(uint16_t filterNumber, bool printMessageFlag) {
  bool success = true;						// Be optimistic.
  filterTest_fillQueue(&yQueue, 0.0);	// zero-out the yQueue so the B-summation is always 0.
  uint16_t startingIndex = filterTest_getIirACoefficientArrayStartingIndex();  // Varies according to student.
  for (uint32_t i=0; i<filterTest_getIirACoefficientCount()-startingIndex; i++) {	// Loop through all of the A-coefficients.
    filterTest_fillQueue(&(zQueue[filterNumber]), 0.0);				// zero out the zQueue for filterNumber.
    queue_overwritePush(&(zQueue[filterNumber]), 1.0);		// Add a single 1.0 to the queue.
    for (uint32_t j=0; j<i; j++) {												// Move over the 1.0 an additional position each time through the loop.
      queue_overwritePush(&(zQueue[filterNumber]), 0.0);	// Move the 1.0 over by writing the correct number of zeros.
    }
    filter_iirFilter(filterNumber);										// Run the IIR filter.
    double iirValue = filterTest_filter_readMostRecentValueFromQueue(&(zQueue[filterNumber]));										// Run the IIR filter.
    double iirGoldenOutput =  filterTest_getIirACoefficientArray(filterNumber)[i+startingIndex];	// Golden output is simply the coefficient.
    if (!filterTest_floatingPointEqual(iirValue, -iirGoldenOutput)) {							// Check to see that the IIR-output matches the correct coefficient value.
      success = false;																									// Note the failure of the test and print an info message.
      printf("filter_runIirAlignmentTest: Output from IIR Filter[%d](%le) does not match test-data(%le) at index(%ld).\n\r", filterNumber, iirValue, iirGoldenOutput, i);
    }
  }
  // Print informational messages.
  if (printMessageFlag) {
    printf("filter_runIirAAlignmentTest ");
    if (success)
      printf("passed.\n\r");
    else
      printf("failed.\n\r");
  }
  return success;	// Return the failure or success of the test.
}

// Normalizes the values in the array argument.
void filterTest_normalizeArrayValues(double* array, uint16_t size) {
  // Find the maximum value
  uint16_t maxIndex = 0;
  // Find the index of the max value in the array.
  for (int i=0; i<size; i++) {
    if (array[i] > array[maxIndex])
      maxIndex = i;
  }
  double maxPowerValue = array[maxIndex];
  // Normalize everything between 0.0 and 1.0, based upon the max value.
  for (int i=0; i<size; i++)
    array[i] = array[i] / maxPowerValue;
}

#define FILTER_FIR_POWER_TEST_PERIOD_COUNT 22
#define FILTER_TEST_HISTOGRAM_BAR_COUNT FILTER_FIR_POWER_TEST_PERIOD_COUNT
// Everything is defined assuming a 100 kHz sample rate.
static const uint16_t filter_testPeriodTickCounts[FILTER_FIR_POWER_TEST_PERIOD_COUNT] = {90, 72, 58, 50, 44, 38, 34, 30, 28, 26, 24, 22, 20, 18, 16, 14, 12, 10, 8, 6, 4, 2};
#define MAX_BUF 10
#define FILTER_TEST_PULSE_WIDTH_LENGTH 20000

// Plots the frequency response of the FIR filter on the TFT.
// Everything is defined assuming a 100 kHz sample rate.
// Frequencies run from 1.1 kHz to 50 kHz.
void filterTest_runFirPowerTest(bool printMessageFlag) {
  if (printMessageFlag) {
    // Tells you that this function is plotting the frequency response for the FIR filter for a set of frequencies.
    printf("running filter_runFirPowerTest() - plotting power values (frequency response) for frequencies %1.2lf kHz to %1.2lf kHz for FIR filter to TFT display.\n\r",
	   ((double) ((FILTER_SAMPLE_FREQUENCY_IN_KHZ))/filter_testPeriodTickCounts[0]),
	   ((double) ((FILTER_SAMPLE_FREQUENCY_IN_KHZ))/filter_testPeriodTickCounts[FILTER_FIR_POWER_TEST_PERIOD_COUNT-1]));
  }
  firDecimationCount = 0;
  double testPeriodPowerValue[FILTER_FIR_POWER_TEST_PERIOD_COUNT];	// Computed power values will go here.
  uint16_t freqCount=0;	// Used to print info message.
  // Simulate running everything at 100 kHz. Simply add either 1.0 or -1.0 to xQueue based upon the
  // the frequency you are simulating.
  // Iterate over all of the test-periods.
  for (uint16_t testPeriodIndex=0; testPeriodIndex<FILTER_FIR_POWER_TEST_PERIOD_COUNT; testPeriodIndex++) {
    uint16_t currentPeriodTickCount = filter_testPeriodTickCounts[testPeriodIndex];
    double power = 0.0;						// Temp variable to compute power.
    uint32_t totalTickCount = 0;	// Keep track of where you are in the period.
    while (totalTickCount < FILTER_TEST_PULSE_WIDTH_LENGTH) {	// Keep going until you have completed the entire pulse-width.
      for (uint16_t freqTick = 0; freqTick < currentPeriodTickCount; freqTick++) {	// This loop completes a single period.
	if (freqTick < currentPeriodTickCount/2)	// The first half of the period is -1.0.
	  filter_addNewInput(-1.0);		// Add the simulated value to the FIR filter.
	else
	  filter_addNewInput(+1.0);		// In the second half of the period, add +1.0 to the FIR filter.
	if (filter_decimatingFirFilter()) {	// Tells us if we ran the the FIR filter (we are decimating so the FIR filter only runs every 10 input values).
	  double firOutput = filterTest_filter_readMostRecentValueFromQueue(&yQueue);	// Get the output from the yQueue.
	  power += firOutput * firOutput;	// Compute the power so far.
	  totalTickCount++;
	}
      }
    }
    testPeriodPowerValue[testPeriodIndex] = power;	// All done computing power for this period, move on to the next one.
    //		printf("Frequency[%d](%5.4lf) Power:%5.2le\n\r", freqCount, (double) (FILTER_SAMPLE_FREQUENCY_IN_KHZ/currentPeriodTickCount), power);
    freqCount++;
  }
  // Now we start plotting the results.
  filterTest_normalizeArrayValues(testPeriodPowerValue, FILTER_FIR_POWER_TEST_PERIOD_COUNT);	// Normalize the values.
  histogram_init(FILTER_TEST_HISTOGRAM_BAR_COUNT);	// Init the histogram.
  // Set labels and colors (blue) for the standard frequencies 0-9.
  for (int i=0; i<FILTER_FREQUENCY_COUNT; i++) {
    histogram_setBarColor(i, DISPLAY_BLUE);		// Sets the color of the bar.
    char tempLabel[MAX_BUF];									// Temp variable for label generation.
    snprintf(tempLabel, MAX_BUF, "%d", i);		// Create the label that represents one of the user frequencies.
    histogram_setBarLabel(i, tempLabel);			// Finally, set the label.
  }
  // Set the colors for the other nonstandard frequencies to be red so that the stand out.
  for (int i=10; i<FILTER_FIR_POWER_TEST_PERIOD_COUNT; i++) {
    histogram_setBarColor(i, DISPLAY_RED);
    char tempLabel[MAX_BUF];	// Used to create labels.
    // Create three kinds of labels.
    // 1. Just label the first set of defined frequencies 0-9.
    // 2. This is the start of the frequencies outside the actual transmitted frequencies.
    // The bounds are printed at the start and end of this range, using the labels so that they display OK in the limited space.
    // 3. The lower bound for out-of-bound testing frequencies.
    if (i == 10) {
      snprintf(tempLabel, MAX_BUF, "%dkHz",  FILTER_SAMPLE_FREQUENCY_IN_KHZ/filter_testPeriodTickCounts[i]);
      histogram_setBarLabel(i, tempLabel);
      // 4. Print the upper bound for out-of-bound testing frequencies further to the left to make readable.
    } else if (i == FILTER_FIR_POWER_TEST_PERIOD_COUNT-4) {
      snprintf(tempLabel, MAX_BUF, "%dkHz",  FILTER_SAMPLE_FREQUENCY_IN_KHZ/filter_testPeriodTickCounts[FILTER_FIR_POWER_TEST_PERIOD_COUNT-1]);
      histogram_setBarLabel(i, tempLabel);
      // Print a "-" for readability.
    } else if (i == FILTER_FIR_POWER_TEST_PERIOD_COUNT-7) {
      histogram_setBarLabel(i, "-");
      // Print blank space everywhere else.
    } else {
      histogram_setBarLabel(i, "");

    }
  }
  // Set the actual histogram-bar data to be power values..
  for (uint16_t barIndex=0; barIndex<FILTER_TEST_HISTOGRAM_BAR_COUNT; barIndex++) {
    histogram_setBarData(barIndex, testPeriodPowerValue[barIndex] * HISTOGRAM_MAX_BAR_DATA_IN_PIXELS, "");
  }
  histogram_redrawBottomLabels();  // Need to redraw the bottom labels because I changed the colors.
  histogram_updateDisplay();	   // Redraw the histogram.
}

// Plots frequency response for the selected filterNumber against the 10 standard frequencies.
void filterTest_runIirPowerTest(uint16_t filterNumber, bool printMessageFlag) {
  if (printMessageFlag) {
    printf("running filter_runFirPowerTest(%d) - plotting power for all player frequencies for IIR filter(%d) to TFT display.\n\r", filterNumber, filterNumber);
  }
  firDecimationCount = 0;
  double testPeriodPowerValue[FILTER_IIR_POWER_TEST_PERIOD_COUNT];	// Keep track of power values here.
  uint16_t freqCount=0;
  // Simulate running everything at 100 kHz.
  for (uint16_t testPeriodIndex=0; testPeriodIndex<FILTER_FREQUENCY_COUNT; testPeriodIndex++) {  // Only use the first 10 standard frequencies.
    uint16_t currentPeriodTickCount = filter_testPeriodTickCounts[testPeriodIndex];		// You will be generating a frequency with this period.
    double power = 0.0;						// Used to compute power.
    uint32_t totalTickCount = 0;	// Keep track of where you are in the given period.
    while (totalTickCount < FILTER_TEST_PULSE_WIDTH_LENGTH) {		// Generate a pulse-width of periods.
      double iirOutput = 0.0;		// Output from the IIR filter.
      for (uint16_t freqTick = 0; freqTick < currentPeriodTickCount; freqTick++) {	// This loop generates one period of the frequency.
	if (freqTick < currentPeriodTickCount/2)	// First half of period is -1.0.
	  filter_addNewInput(-1.0);
	else
	  filter_addNewInput(+1.0);								// Second half of period is +1.0
	if (filter_decimatingFirFilter()) {				// If you actually ran the FIR-filter, run the IIR-filter.
	  filter_iirFilter(filterNumber);
	  iirOutput = filterTest_filter_readMostRecentValueFromQueue(&(zQueue[filterNumber]));
	}
	power += iirOutput * iirOutput;	// Compute the power at the output.
	totalTickCount++;
      }
    }
    testPeriodPowerValue[testPeriodIndex] = power;
    //		printf("Frequency[%d](%5.4lf) Power:%5.2le\n\r", freqCount, (double) (FILTER_SAMPLE_FREQUENCY_IN_KHZ/currentPeriodTickCount), power);
    freqCount++;
  }
  // Make a copy of the power values that you will normalize.
  double normalizedPowerValue[FILTER_IIR_POWER_TEST_PERIOD_COUNT];
  for (int i=0; i<FILTER_IIR_POWER_TEST_PERIOD_COUNT; i++) {
    normalizedPowerValue[i] = testPeriodPowerValue[i];
  }
  filterTest_normalizeArrayValues(normalizedPowerValue, FILTER_IIR_POWER_TEST_PERIOD_COUNT);
  histogram_init(FILTER_IIR_POWER_TEST_PERIOD_COUNT);
  // Set labels and colors (red) for the standard frequencies 0-9.
  // Default is red but will change the color for the desired frequency to be blue.
  for (int i=0; i<FILTER_IIR_POWER_TEST_PERIOD_COUNT; i++) {
    histogram_setBarColor(i, DISPLAY_RED);
    char tempLabel[MAX_BUF];
    snprintf(tempLabel, MAX_BUF, "%d", i);
    histogram_setBarLabel(i, tempLabel);
  }
  histogram_setBarColor(filterNumber, DISPLAY_BLUE);	// Desired frequency drawn in blue.
  for (uint16_t barIndex=0; barIndex<FILTER_IIR_POWER_TEST_PERIOD_COUNT; barIndex++) {
    char label[HISTOGRAM_BAR_TOP_MAX_LABEL_WIDTH_IN_CHARS];	// Get a buffer for the label.
    // Create the top-label, based upon the actual power value.
    if (snprintf(label, HISTOGRAM_BAR_TOP_MAX_LABEL_WIDTH_IN_CHARS, "%0.0e", testPeriodPowerValue[barIndex]) == -1)
      printf("Error: snprintf encountered an error during conversion.\n\r");
    // Pull out the 'e' from the exponent to make better use of your characters.
    trimLabel(label);
    histogram_setBarData(barIndex, normalizedPowerValue[barIndex] * HISTOGRAM_MAX_BAR_DATA_IN_PIXELS, label);	// No top-label.
  }
  histogram_redrawBottomLabels();  // Need to redraw the bottom labels because I changed the colors.
  histogram_updateDisplay();	   // Redraw the histogram.
}

// 1. Tests the FIR filter in isolation using test-data, with no decimation.
// 2. Tests the FIR-filter using actual data, with decimation, using data generated by the transmitter code but not going
// through the ADC. The data generated by the transmitter are scaled between -1.0 and 1.0 and placed directly in the xQueue.
// The power in the FIR output is measured and compared to a threshold.
// 3. Tests the IIR in isolation using test-data.
// 4. Tests the
#define TEN_SECONDS 10000
#define TWO_SECONDS 2000
bool filter_runTest() {
  bool success = true;	// Be optimistic.
  filter_init();
  success &= filterTest_runFirAlignmentTest(true);
  success &= filterTest_runFirArithmeticTest(true);
  success &= filterTest_runIirAAlignmentTest(0, true);
  success &= filterTest_runIirBAlignmentTest(0, true);
  filterTest_runFirPowerTest(true);
  utils_msDelay(TEN_SECONDS);
  for (int i=0; i<FILTER_IIR_FILTER_COUNT; i++) {
    filterTest_runIirPowerTest(i, true);
    utils_msDelay(TWO_SECONDS);
  }
  return success;
}

